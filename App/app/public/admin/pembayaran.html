<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kelola Pembayaran - Ashanum Admin</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="/favicon.png?v=2">
  <link rel="stylesheet" href="assets/css/style.css">

  <style>
    /* ===== MODAL OVERRIDE ‚Äî paksa tampil di atas segalanya ===== */
    .modal-fixed-overlay {
      display: none;
      position: fixed !important;
      inset: 0 !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      background: rgba(0, 0, 0, 0.55) !important;
      z-index: 99999 !important;
      align-items: center !important;
      justify-content: center !important;
      padding: 20px;
      box-sizing: border-box;
      backdrop-filter: blur(3px);
      animation: fadeInOverlay .18s ease;
    }
    .modal-fixed-overlay.show {
      display: flex !important;
    }
    @keyframes fadeInOverlay {
      from { opacity: 0; }
      to   { opacity: 1; }
    }

    .modal-fixed-box {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 25px 60px rgba(0,0,0,.25);
      width: 100%;
      max-width: 860px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      animation: slideUpModal .2s ease;
      position: relative;
    }
    @keyframes slideUpModal {
      from { transform: translateY(30px); opacity: 0; }
      to   { transform: translateY(0);    opacity: 1; }
    }

    .modal-fixed-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      flex-shrink: 0;
    }
    .modal-fixed-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .modal-fixed-close {
      background: rgba(255,255,255,.2);
      border: none;
      color: #fff;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background .15s;
    }
    .modal-fixed-close:hover { background: rgba(255,255,255,.35); }

    .modal-fixed-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-fixed-footer {
      padding: 16px 24px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      flex-shrink: 0;
      background: #f9fafb;
    }

    /* Info grid di dalam modal */
    .modal-info-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 16px;
    }
    .modal-info-grid.col2 { grid-template-columns: repeat(2, 1fr); }
    @media (max-width: 640px) {
      .modal-info-grid, .modal-info-grid.col2 { grid-template-columns: 1fr 1fr; }
    }

    .info-item label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: .5px;
      margin-bottom: 4px;
    }
    .info-item .val {
      font-size: 14px;
      color: #111827;
      font-weight: 500;
    }
    .info-item .val.big {
      font-size: 18px;
      font-weight: 800;
      color: #1d4ed8;
    }

    .modal-divider {
      border: none;
      border-top: 1px solid #f0f0f0;
      margin: 16px 0;
    }

    /* Raw response */
    #mRaw {
      background: #0f172a;
      color: #94a3b8;
      padding: 14px;
      border-radius: 10px;
      overflow: auto;
      max-height: 180px;
      font-size: 12px;
      line-height: 1.6;
      margin: 0;
    }

    /* Tombol aksi di tabel */
    .btn-eye {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 34px;
      height: 34px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      transition: all .15s;
      background: #eff6ff;
      color: #1d4ed8;
    }
    .btn-eye:hover { background: #1d4ed8; color: #fff; transform: scale(1.08); }

    .btn-check {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 34px;
      height: 34px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      transition: all .15s;
      background: #f0fdf4;
      color: #16a34a;
    }
    .btn-check:hover { background: #16a34a; color: #fff; transform: scale(1.08); }
    .btn-check:disabled { opacity: .4; cursor: not-allowed; transform: none; }
  </style>
</head>
<body>
  <div class="admin-wrapper">
    <div id="sidebar-container"></div>

    <div class="main-content">
      <div id="header-container"></div>

      <div class="content-wrapper">
        <div class="page-header" style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
          <div>
            <h1 class="page-title">Kelola Pembayaran</h1>
            <p class="page-subtitle">Monitoring pembayaran, konfirmasi manual, dan audit transaksi</p>
          </div>
          <button class="btn btn-secondary" id="btnRefresh">
            <i class="fas fa-rotate"></i> Refresh
          </button>
        </div>

        <div id="alertContainer"></div>

        <!-- STATS -->
        <div class="form-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:16px;">
          <div class="card">
            <div class="card-body">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                  <div style="color:#6b7280;font-size:12px;">Total Pembayaran</div>
                  <div id="statTotal" style="font-weight:800;font-size:22px;">0</div>
                </div>
                <div style="font-size:26px;">üí≥</div>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-body">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                  <div style="color:#6b7280;font-size:12px;">Menunggu</div>
                  <div id="statMenunggu" style="font-weight:800;font-size:22px;">0</div>
                </div>
                <div style="font-size:26px;">‚è≥</div>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-body">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                  <div style="color:#6b7280;font-size:12px;">Berhasil</div>
                  <div id="statBerhasil" style="font-weight:800;font-size:22px;">0</div>
                </div>
                <div style="font-size:26px;">‚úÖ</div>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-body">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                  <div style="color:#6b7280;font-size:12px;">Kadaluarsa / Gagal</div>
                  <div id="statProblem" style="font-weight:800;font-size:22px;">0</div>
                </div>
                <div style="font-size:26px;">‚ö†Ô∏è</div>
              </div>
            </div>
          </div>
        </div>

        <!-- FILTER -->
        <div class="filter-section">
          <div class="form-grid">
            <div class="form-group">
              <label>Cari ID Pembayaran / Order ID</label>
              <input type="text" id="searchId" placeholder="Contoh: 12 atau 99">
            </div>
            <div class="form-group">
              <label>Filter Status</label>
              <select id="filterStatus">
                <option value="">Semua Status</option>
                <option value="MENUNGGU">MENUNGGU</option>
                <option value="BERHASIL">BERHASIL</option>
                <option value="GAGAL">GAGAL</option>
                <option value="KADALUARSA">KADALUARSA</option>
                <option value="DIBATALKAN">DIBATALKAN</option>
              </select>
            </div>
            <div class="form-group">
              <label>Dari Tanggal</label>
              <input type="date" id="filterTanggalDari">
            </div>
            <div class="form-group">
              <label>Sampai Tanggal</label>
              <input type="date" id="filterTanggalSampai">
            </div>
          </div>
          <div class="filter-actions">
            <button class="btn btn-primary" id="btnApply"><i class="fas fa-search"></i> Cari</button>
            <button class="btn btn-secondary" id="btnReset"><i class="fas fa-redo"></i> Reset</button>
          </div>
        </div>

        <!-- TABLE -->
        <div class="card">
          <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
            <h3 class="card-title">Daftar Pembayaran</h3>
            <small style="color:#6b7280;">Klik üëÅ untuk melihat detail lengkap</small>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Order</th>
                    <th>User</th>
                    <th>Metode</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Expired</th>
                    <th>Tanggal</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody id="tableBody">
                  <tr>
                    <td colspan="9">
                      <div class="loading">
                        <div class="spinner"></div>
                        <p>Memuat data...</p>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="pagination" id="pagination"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== MODAL DETAIL ‚Äî di LUAR admin-wrapper ===== -->
  <div class="modal-fixed-overlay" id="detailModal">
    <div class="modal-fixed-box">

      <div class="modal-fixed-header">
        <h2><i class="fas fa-receipt"></i> Detail Pembayaran</h2>
        <button class="modal-fixed-close" id="btnCloseModal" type="button">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-fixed-body">

        <!-- Baris 1: ID, Order, Status, Amount -->
        <div class="modal-info-grid">
          <div class="info-item">
            <label>ID Pembayaran</label>
            <div class="val" id="mPayId">-</div>
          </div>
          <div class="info-item">
            <label>Order ID</label>
            <div class="val" id="mOrderId">-</div>
          </div>
          <div class="info-item">
            <label>Status Pembayaran</label>
            <div id="mStatus">-</div>
          </div>
          <div class="info-item">
            <label>Metode</label>
            <div class="val" id="mMetode">-</div>
          </div>
          <div class="info-item">
            <label>Provider</label>
            <div class="val" id="mProvider">-</div>
          </div>
          <div class="info-item">
            <label>Total Pembayaran</label>
            <div class="val big" id="mAmount">-</div>
          </div>
        </div>

        <hr class="modal-divider">

        <!-- Baris 2: Waktu -->
        <div class="modal-info-grid">
          <div class="info-item">
            <label>Expired At</label>
            <div class="val" id="mExpiredAt">-</div>
          </div>
          <div class="info-item">
            <label>Paid At</label>
            <div class="val" id="mPaidAt">-</div>
          </div>
          <div class="info-item">
            <label>Dibuat Pada</label>
            <div class="val" id="mCreatedAt">-</div>
          </div>
        </div>

        <hr class="modal-divider">

        <!-- Baris 3: User & Status Pesanan -->
        <div class="modal-info-grid col2">
          <div class="info-item">
            <label>Email User</label>
            <div class="val" id="mUser">-</div>
          </div>
          <div class="info-item">
            <label>Status Pesanan</label>
            <div class="val" id="mOrderStatus">-</div>
          </div>
        </div>

        <hr class="modal-divider">

        <!-- Raw Response -->
        <div class="info-item">
          <label>Raw Response</label>
          <pre id="mRaw">-</pre>
        </div>

      </div><!-- /modal-body -->

      <div class="modal-fixed-footer">
        <button class="btn btn-secondary" id="btnModalClose2" type="button">
          <i class="fas fa-times"></i> Tutup
        </button>
        <button class="btn btn-success" id="btnConfirmPaid" type="button">
          <i class="fas fa-check"></i> Tandai BERHASIL
        </button>
      </div>

    </div>
  </div>
  <!-- /MODAL -->

  <script src="assets/js/config.js"></script>
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/main.js"></script>
  <script src="assets/js/helpers.js"></script>
  <script src="../assets/js/alert.js"></script>

  <script>
    let allPayments = [];
    let filteredPayments = [];
    let pagination = null;
    let searchId = '';
    let filterStatus = '';
    let filterTanggalDari = '';
    let filterTanggalSampai = '';
    let currentModalPayment = null;

    /* ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ */
    function formatRupiah(n) {
      return "Rp " + Number(n || 0).toLocaleString("id-ID");
    }

    function formatDate(d) {
      if (!d) return "-";
      const dt = new Date(d);
      if (isNaN(dt)) return "-";
      return dt.toLocaleDateString("id-ID", {
        day: "numeric", month: "short", year: "numeric",
        hour: "2-digit", minute: "2-digit"
      });
    }

    function statusBadge(status) {
      const s = String(status || "").toUpperCase();
      const map = {
        MENUNGGU:   { cls: "badge-warning",   text: "MENUNGGU" },
        BERHASIL:   { cls: "badge-success",   text: "BERHASIL" },
        GAGAL:      { cls: "badge-danger",    text: "GAGAL" },
        KADALUARSA: { cls: "badge-info",      text: "KADALUARSA" },
        DIBATALKAN: { cls: "badge-danger",    text: "DIBATALKAN" },
      };
      return map[s] || { cls: "badge-secondary", text: s || "-" };
    }

    function metodeLabel(p) {
      const m = String(p.metode || "-").toUpperCase();
      return p.provider ? `${m} ¬∑ ${p.provider}` : m;
    }

    function isExpired(p) {
      if (!p.expiredAt) return false;
      if (String(p.status || "").toUpperCase() !== "MENUNGGU") return false;
      return new Date(p.expiredAt).getTime() <= Date.now();
    }

    function computeStats(list) {
      document.getElementById("statTotal").textContent = list.length;
      document.getElementById("statMenunggu").textContent =
        list.filter(x => String(x.status||"").toUpperCase() === "MENUNGGU").length;
      document.getElementById("statBerhasil").textContent =
        list.filter(x => String(x.status||"").toUpperCase() === "BERHASIL").length;
      document.getElementById("statProblem").textContent =
        list.filter(x => ["GAGAL","KADALUARSA","DIBATALKAN"].includes(String(x.status||"").toUpperCase())).length;
    }

    /* ‚îÄ‚îÄ‚îÄ Load ‚îÄ‚îÄ‚îÄ */
    async function loadPayments() {
      try {
        const data = await apiRequest("/api/admin/pembayaran");
        allPayments = (data || []).slice().sort((a,b) => new Date(b.dibuatPada) - new Date(a.dibuatPada));
        computeStats(allPayments);
        applyFilters();
      } catch (e) {
        console.error(e);
        showAlert("Gagal memuat data pembayaran", "error");
        document.getElementById("tableBody").innerHTML =
          `<tr><td colspan="9" class="text-center" style="padding:30px;color:#6b7280;">Gagal memuat data. Coba refresh.</td></tr>`;
      }
    }

    /* ‚îÄ‚îÄ‚îÄ Filter ‚îÄ‚îÄ‚îÄ */
    function applyFilters() {
      filteredPayments = allPayments.filter(p => {
        if (searchId) {
          const s = String(searchId).trim();
          if (!String(p.id||"").includes(s) && !String(p.pesananId||p.pesanan?.id||"").includes(s)) return false;
        }
        if (filterStatus && String(p.status||"").toUpperCase() !== filterStatus.toUpperCase()) return false;
        if (filterTanggalDari || filterTanggalSampai) {
          const d = new Date(p.dibuatPada);
          if (filterTanggalDari) { const f=new Date(filterTanggalDari); f.setHours(0,0,0,0); if(d<f) return false; }
          if (filterTanggalSampai) { const t=new Date(filterTanggalSampai); t.setHours(23,59,59,999); if(d>t) return false; }
        }
        return true;
      });
      renderTable();
    }

    function resetFilters() {
      searchId = filterStatus = filterTanggalDari = filterTanggalSampai = '';
      document.getElementById("searchId").value = '';
      document.getElementById("filterStatus").value = '';
      document.getElementById("filterTanggalDari").value = '';
      document.getElementById("filterTanggalSampai").value = '';
      applyFilters();
    }

    /* ‚îÄ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ */
    function renderTable() {
      if (typeof Pagination === "function") {
        pagination = new Pagination(filteredPayments, 10);
        renderCurrentPage();
      } else {
        renderRows(filteredPayments);
        document.getElementById("pagination").innerHTML = "";
      }
    }

    function renderCurrentPage() {
      renderRows(pagination.getCurrentItems());
      pagination.renderPagination("pagination", renderCurrentPage);
    }

    function renderRows(items) {
      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";

      if (!items.length) {
        tbody.innerHTML = `
          <tr><td colspan="9" class="text-center" style="padding:40px;">
            <i class="fas fa-inbox" style="font-size:48px;color:var(--gray-300);display:block;margin-bottom:12px;"></i>
            Tidak ada data pembayaran
          </td></tr>`;
        return;
      }

      items.forEach(p => {
        const st = statusBadge(p.status);
        const orderId = p.pesananId || p.pesanan?.id || "-";
        const userEmail = p.pesanan?.pengguna?.email || "-";
        const expiredText = p.expiredAt ? formatDate(p.expiredAt) : "-";
        const warnExp = isExpired(p) ? `<span style="color:#f59e0b;font-size:11px;font-weight:700;display:block;">‚ö† EXPIRED</span>` : "";
        const isMenunggu = String(p.status||"").toUpperCase() === "MENUNGGU";

        tbody.innerHTML += `
          <tr>
            <td><strong>#${p.id}</strong></td>
            <td><a href="pesanan-detail.html?orderId=${encodeURIComponent(orderId)}" style="font-weight:700;color:#1d4ed8;">#${orderId}</a></td>
            <td>${userEmail}</td>
            <td><span style="font-size:13px;">${metodeLabel(p)}</span></td>
            <td><strong>${formatRupiah(p.amount)}</strong></td>
            <td><span class="badge ${st.cls}">${st.text}</span></td>
            <td>${expiredText}${warnExp}</td>
            <td>${formatDate(p.dibuatPada)}</td>
            <td>
              <div style="display:flex;gap:6px;align-items:center;">
                <button class="btn-eye" onclick="openDetail(${p.id})" title="Lihat Detail">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn-check" onclick="confirmPaid(${p.id})" title="Tandai Berhasil"
                  ${!isMenunggu ? "disabled" : ""}>
                  <i class="fas fa-check"></i>
                </button>
              </div>
            </td>
          </tr>`;
      });
    }

    /* ‚îÄ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ */
    function setModalVisible(v) {
      const el = document.getElementById("detailModal");
      el.classList.toggle("show", v);
      document.body.style.overflow = v ? "hidden" : "";
    }

    window.openDetail = function(id) {
      const p = allPayments.find(x => Number(x.id) === Number(id));
      if (!p) return showAlert("Data pembayaran tidak ditemukan", "error");
      currentModalPayment = p;

      const st = statusBadge(p.status);
      const orderId = p.pesananId || p.pesanan?.id || "-";

      document.getElementById("mPayId").textContent = "#" + (p.id || "-");
      document.getElementById("mOrderId").innerHTML =
        `<a href="pesanan-detail.html?orderId=${encodeURIComponent(orderId)}" style="color:#1d4ed8;font-weight:700;">#${orderId}</a>`;
      document.getElementById("mStatus").innerHTML = `<span class="badge ${st.cls}">${st.text}</span>`;
      document.getElementById("mMetode").textContent = String(p.metode || "-");
      document.getElementById("mProvider").textContent = p.provider || "-";
      document.getElementById("mAmount").textContent = formatRupiah(p.amount);
      document.getElementById("mExpiredAt").textContent = formatDate(p.expiredAt);
      document.getElementById("mPaidAt").textContent = formatDate(p.paidAt);
      document.getElementById("mCreatedAt").textContent = formatDate(p.dibuatPada);
      document.getElementById("mUser").textContent = p.pesanan?.pengguna?.email || "-";
      document.getElementById("mOrderStatus").textContent = p.pesanan?.status || "-";
      document.getElementById("mRaw").textContent =
        p.rawResponse ? JSON.stringify(p.rawResponse, null, 2) : "Tidak ada data raw response";

      const btnConfirm = document.getElementById("btnConfirmPaid");
      const isMenunggu = String(p.status||"").toUpperCase() === "MENUNGGU";
      btnConfirm.disabled = !isMenunggu;
      btnConfirm.style.opacity = isMenunggu ? "1" : ".5";
      btnConfirm.style.cursor = isMenunggu ? "pointer" : "not-allowed";

      setModalVisible(true);
    };

    /* ‚îÄ‚îÄ‚îÄ Actions ‚îÄ‚îÄ‚îÄ */
    window.confirmPaid = async function(id) {
      if (!confirm("Konfirmasi pembayaran ini sebagai BERHASIL?\nPesanan akan otomatis menjadi DIPROSES.")) return;
      try {
        await apiRequest(`/api/admin/pembayaran/${id}/berhasil`, { method: "PATCH" });
        showAlert("Pembayaran dikonfirmasi. Pesanan masuk DIPROSES.", "success");
        setModalVisible(false);
        await loadPayments();
      } catch (e) {
        console.error(e);
        showAlert(e.message || "Gagal konfirmasi pembayaran", "error");
      }
    };

    document.getElementById("btnConfirmPaid").addEventListener("click", () => {
      if (currentModalPayment) confirmPaid(currentModalPayment.id);
    });

    /* ‚îÄ‚îÄ‚îÄ Wire up events ‚îÄ‚îÄ‚îÄ */
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("searchId").addEventListener("input", e => { searchId = e.target.value || ""; });
      document.getElementById("filterStatus").addEventListener("change", e => { filterStatus = e.target.value || ""; });
      document.getElementById("filterTanggalDari").addEventListener("change", e => { filterTanggalDari = e.target.value || ""; });
      document.getElementById("filterTanggalSampai").addEventListener("change", e => { filterTanggalSampai = e.target.value || ""; });

      document.getElementById("btnApply").addEventListener("click", applyFilters);
      document.getElementById("btnReset").addEventListener("click", resetFilters);
      document.getElementById("btnRefresh").addEventListener("click", loadPayments);

      document.getElementById("btnCloseModal").addEventListener("click", () => setModalVisible(false));
      document.getElementById("btnModalClose2").addEventListener("click", () => setModalVisible(false));

      // Klik di luar box = tutup
      document.getElementById("detailModal").addEventListener("click", e => {
        if (e.target === document.getElementById("detailModal")) setModalVisible(false);
      });

      // ESC = tutup
      document.addEventListener("keydown", e => {
        if (e.key === "Escape") setModalVisible(false);
      });

      loadPayments();
    });
  </script>
</body>
</html>