<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kelola Pembayaran - Ashanum Admin</title>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
  <div class="admin-wrapper">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2 class="sidebar-logo">Ashanum</h2>
        <button class="sidebar-toggle" id="sidebarToggle"><i class="fas fa-times"></i></button>
      </div>

      <nav class="sidebar-nav">
        <a href="index.html" class="nav-item"><i class="fas fa-chart-line"></i><span>Dashboard</span></a>
        <div class="nav-section">Master Data</div>
        <a href="kategori.html" class="nav-item"><i class="fas fa-tags"></i><span>Kategori</span></a>
        <a href="produk.html" class="nav-item"><i class="fas fa-box"></i><span>Produk</span></a>

        <div class="nav-section">Transaksi</div>
        <a href="pesanan.html" class="nav-item"><i class="fas fa-shopping-cart"></i><span>Pesanan</span></a>
        <a href="pembayaran.html" class="nav-item active"><i class="fas fa-credit-card"></i><span>Pembayaran</span></a>

        <div class="nav-section">Pengguna</div>
        <a href="pengguna.html" class="nav-item"><i class="fas fa-users"></i><span>Kelola Pengguna</span></a>
      </nav>
    </aside>

    <!-- MAIN -->
    <div class="main-content">
      <header class="topbar">
        <button class="menu-toggle" id="menuToggle"><i class="fas fa-bars"></i></button>
        <div class="topbar-right">
          <div class="topbar-item"><i class="fas fa-bell"></i><span class="badge">5</span></div>
          <div class="topbar-item user-menu">
            <img src="https://ui-avatars.com/api/?name=Admin&background=667eea&color=fff" alt="Admin">
            <span>Admin</span><i class="fas fa-chevron-down"></i>
          </div>
        </div>
      </header>

      <div class="content-wrapper">
        <div class="page-header" style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
          <div>
            <h1 class="page-title">Kelola Pembayaran</h1>
            <p class="page-subtitle">Monitoring pembayaran, konfirmasi manual, dan audit transaksi</p>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn btn-secondary" id="btnRefresh"><i class="fas fa-rotate"></i> Refresh</button>
          </div>
        </div>

        <div id="alertContainer"></div>

        <!-- STATS -->
        <div class="form-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 16px;">
          <div class="card">
            <div class="card-body">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                  <div style="color:#6b7280;font-size:12px;">Total Pembayaran</div>
                  <div id="statTotal" style="font-weight:800;font-size:20px;">0</div>
                </div>
                <div style="font-size:22px;">üí≥</div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                  <div style="color:#6b7280;font-size:12px;">Menunggu</div>
                  <div id="statMenunggu" style="font-weight:800;font-size:20px;">0</div>
                </div>
                <div style="font-size:22px;">‚è≥</div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                  <div style="color:#6b7280;font-size:12px;">Berhasil</div>
                  <div id="statBerhasil" style="font-weight:800;font-size:20px;">0</div>
                </div>
                <div style="font-size:22px;">‚úÖ</div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                  <div style="color:#6b7280;font-size:12px;">Kadaluarsa / Gagal</div>
                  <div id="statProblem" style="font-weight:800;font-size:20px;">0</div>
                </div>
                <div style="font-size:22px;">‚ö†Ô∏è</div>
              </div>
            </div>
          </div>
        </div>

        <!-- FILTER -->
        <div class="filter-section">
          <div class="form-grid">
            <div class="form-group">
              <label>Cari ID Pembayaran / Order ID</label>
              <input type="text" id="searchId" placeholder="Contoh: 12 atau 99">
            </div>
            <div class="form-group">
              <label>Filter Status</label>
              <select id="filterStatus">
                <option value="">Semua Status</option>
                <option value="MENUNGGU">MENUNGGU</option>
                <option value="BERHASIL">BERHASIL</option>
                <option value="GAGAL">GAGAL</option>
                <option value="KADALUARSA">KADALUARSA</option>
                <option value="DIBATALKAN">DIBATALKAN</option>
              </select>
            </div>
            <div class="form-group">
              <label>Dari Tanggal</label>
              <input type="date" id="filterTanggalDari">
            </div>
            <div class="form-group">
              <label>Sampai Tanggal</label>
              <input type="date" id="filterTanggalSampai">
            </div>
          </div>
          <div class="filter-actions">
            <button class="btn btn-primary" id="btnApply"><i class="fas fa-search"></i> Cari</button>
            <button class="btn btn-secondary" id="btnReset"><i class="fas fa-redo"></i> Reset</button>
          </div>
        </div>

        <!-- TABLE -->
        <div class="card">
          <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
            <h3 class="card-title">Daftar Pembayaran</h3>
            <small style="color:#6b7280;">Klik detail untuk melihat informasi lengkap</small>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Order</th>
                    <th>User</th>
                    <th>Metode</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Expired</th>
                    <th>Tanggal</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody id="tableBody">
                  <tr>
                    <td colspan="9">
                      <div class="loading">
                        <div class="spinner"></div>
                        <p>Memuat data...</p>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="pagination" id="pagination"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL DETAIL -->
  <div class="modal-overlay" id="detailModal" style="display:none;">
    <div class="modal-content" style="max-width:860px;">
      <div class="modal-header">
        <h2 class="modal-title"><i class="fas fa-receipt"></i> Detail Pembayaran</h2>
        <button class="close-btn" id="btnCloseModal" type="button"><i class="fas fa-times"></i></button>
      </div>

      <div class="modal-body">
        <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
          <div class="form-group">
            <label>ID Pembayaran</label>
            <div id="mPayId" style="font-weight:700;">-</div>
          </div>
          <div class="form-group">
            <label>Order ID</label>
            <div id="mOrderId" style="font-weight:700;">-</div>
          </div>
          <div class="form-group">
            <label>Status</label>
            <div id="mStatus">-</div>
          </div>
          <div class="form-group">
            <label>Metode</label>
            <div id="mMetode">-</div>
          </div>
          <div class="form-group">
            <label>Provider</label>
            <div id="mProvider">-</div>
          </div>
          <div class="form-group">
            <label>Amount</label>
            <div id="mAmount" style="font-weight:800;">-</div>
          </div>
          <div class="form-group">
            <label>Expired At</label>
            <div id="mExpiredAt">-</div>
          </div>
          <div class="form-group">
            <label>Paid At</label>
            <div id="mPaidAt">-</div>
          </div>
          <div class="form-group">
            <label>Created</label>
            <div id="mCreatedAt">-</div>
          </div>
        </div>

        <hr style="border:none;border-top:1px solid #e5e7eb;margin:12px 0;">

        <div class="form-grid" style="grid-template-columns: repeat(2, 1fr);">
          <div class="form-group">
            <label>User</label>
            <div id="mUser">-</div>
          </div>
          <div class="form-group">
            <label>Status Pesanan</label>
            <div id="mOrderStatus">-</div>
          </div>
        </div>

        <div class="form-group" style="margin-top:10px;">
          <label>Raw Response (opsional)</label>
          <pre id="mRaw" style="background:#0b1220;color:#e5e7eb;padding:12px;border-radius:10px;overflow:auto;max-height:220px;">-</pre>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" id="btnModalClose2" type="button">Tutup</button>
        <button class="btn btn-success" id="btnConfirmPaid" type="button">
          <i class="fas fa-check"></i> Tandai BERHASIL
        </button>
      </div>
    </div>
  </div>

  <!-- Scripts (wajib ada di project kamu) -->
  <script src="assets/js/config.js"></script>
  <script src="assets/js/helpers.js"></script>
  <script src="assets/js/main.js"></script>
  <script src="../assets/js/alert.js"></script>
  <script>
    /**
     * BUTUH:
     * - apiRequest(url, options?) dari assets/js/config.js atau helpers.js (punya kamu)
     * - showAlert(msg,type) dari assets/js/main.js (punya kamu)
     * - Pagination class kalau kamu pakai (kalau belum ada, pakai render tanpa pagination)
     */

    let allPayments = [];
    let filteredPayments = [];
    let pagination = null;

    let searchId = '';
    let filterStatus = '';
    let filterTanggalDari = '';
    let filterTanggalSampai = '';

    // modal state
    let currentModalPayment = null;

    // ===== helpers local =====
    function formatRupiah(n) {
      return "Rp " + Number(n || 0).toLocaleString("id-ID");
    }

    function formatDate(dateString) {
      if (!dateString) return "-";
      const d = new Date(dateString);
      if (Number.isNaN(d.getTime())) return "-";
      return d.toLocaleDateString("id-ID", {
        day: "numeric",
        month: "short",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit"
      });
    }

    function statusBadge(status) {
      const s = String(status || "").toUpperCase();
      const map = {
        MENUNGGU: { class: "badge-warning", text: "MENUNGGU" },
        BERHASIL: { class: "badge-success", text: "BERHASIL" },
        GAGAL: { class: "badge-danger", text: "GAGAL" },
        KADALUARSA: { class: "badge-info", text: "KADALUARSA" },
        DIBATALKAN: { class: "badge-danger", text: "DIBATALKAN" },
      };
      return map[s] || { class: "badge-secondary", text: s || "-" };
    }

    function metodeLabel(p) {
      const m = String(p.metode || "-").toUpperCase();
      const prov = p.provider ? ` ‚Ä¢ ${p.provider}` : "";
      return `${m}${prov}`;
    }

    function isExpired(p) {
      if (!p.expiredAt) return false;
      if (String(p.status || "").toUpperCase() !== "MENUNGGU") return false;
      return new Date(p.expiredAt).getTime() <= Date.now();
    }

    function computeStats(list) {
      const total = list.length;
      const menunggu = list.filter(x => String(x.status||"").toUpperCase() === "MENUNGGU").length;
      const berhasil = list.filter(x => String(x.status||"").toUpperCase() === "BERHASIL").length;
      const problem = list.filter(x => ["GAGAL","KADALUARSA","DIBATALKAN"].includes(String(x.status||"").toUpperCase())).length;

      document.getElementById("statTotal").textContent = total;
      document.getElementById("statMenunggu").textContent = menunggu;
      document.getElementById("statBerhasil").textContent = berhasil;
      document.getElementById("statProblem").textContent = problem;
    }

    // ===== load =====
    async function loadPayments() {
      try {
        // endpoint admin:
        // GET /api/admin/pembayaran
        const data = await apiRequest("/api/admin/pembayaran");

        allPayments = (data || []).slice();
        // newest first
        allPayments.sort((a,b) => new Date(b.dibuatPada) - new Date(a.dibuatPada));

        computeStats(allPayments);
        applyFilters();
      } catch (e) {
        console.error(e);
        showAlert("Gagal memuat data pembayaran", "error");
        document.getElementById("tableBody").innerHTML = `
          <tr><td colspan="9" class="text-center" style="padding:30px;color:#6b7280;">
            Gagal memuat data. Coba refresh.
          </td></tr>
        `;
      }
    }

    function applyFilters() {
      filteredPayments = allPayments.filter(p => {
        // search by payment id or order id
        if (searchId) {
          const s = String(searchId).trim();
          const pid = String(p.id || "");
          const oid = String(p.pesananId || p.pesanan?.id || "");
          if (!pid.includes(s) && !oid.includes(s)) return false;
        }

        if (filterStatus) {
          if (String(p.status||"").toUpperCase() !== String(filterStatus).toUpperCase()) return false;
        }

        if (filterTanggalDari || filterTanggalSampai) {
          const d = new Date(p.dibuatPada);
          if (filterTanggalDari) {
            const from = new Date(filterTanggalDari);
            from.setHours(0,0,0,0);
            if (d < from) return false;
          }
          if (filterTanggalSampai) {
            const to = new Date(filterTanggalSampai);
            to.setHours(23,59,59,999);
            if (d > to) return false;
          }
        }

        return true;
      });

      renderTable();
    }

    function resetFilters() {
      document.getElementById("searchId").value = "";
      document.getElementById("filterStatus").value = "";
      document.getElementById("filterTanggalDari").value = "";
      document.getElementById("filterTanggalSampai").value = "";

      searchId = "";
      filterStatus = "";
      filterTanggalDari = "";
      filterTanggalSampai = "";

      applyFilters();
    }

    function renderTable() {
      // kalau project kamu punya Pagination class seperti di pesanan.js
      if (typeof Pagination === "function") {
        pagination = new Pagination(filteredPayments, 10);
        renderCurrentPage();
      } else {
        // fallback no pagination
        renderRows(filteredPayments);
        document.getElementById("pagination").innerHTML = "";
      }
    }

    function renderCurrentPage() {
      const items = pagination.getCurrentItems();
      renderRows(items);
      pagination.renderPagination("pagination", renderCurrentPage);
    }

    function renderRows(items) {
      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";

      if (!items.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" class="text-center" style="padding: 40px;">
              <i class="fas fa-inbox" style="font-size: 48px; color: var(--gray-300); display: block; margin-bottom: 15px;"></i>
              Tidak ada data pembayaran
            </td>
          </tr>
        `;
        return;
      }

      items.forEach(p => {
        const st = statusBadge(p.status);
        const orderId = p.pesananId || p.pesanan?.id || "-";
        const userEmail = p.pesanan?.pengguna?.email || "-";
        const expiredText = p.expiredAt ? formatDate(p.expiredAt) : "-";
        const warnExpired = isExpired(p) ? `<span style="color:#f59e0b;font-weight:700;">(EXPIRED)</span>` : "";

        tbody.innerHTML += `
          <tr>
            <td><strong>#${p.id}</strong></td>
            <td><a href="pesanan-detail.html?orderId=${encodeURIComponent(orderId)}" style="font-weight:700;">#${orderId}</a></td>
            <td>${userEmail}</td>
            <td>${metodeLabel(p)}</td>
            <td><strong>${formatRupiah(p.amount)}</strong></td>
            <td><span class="badge ${st.class}">${st.text}</span></td>
            <td>${expiredText} ${warnExpired}</td>
            <td>${formatDate(p.dibuatPada)}</td>
            <td>
              <div class="action-buttons">
                <button class="btn-icon btn-primary" onclick="openDetail(${p.id})" title="Detail">
                  <i class="fas fa-eye"></i>
                </button>
                ${
                  String(p.status||"").toUpperCase() === "MENUNGGU"
                    ? `<button class="btn-icon btn-success" onclick="confirmPaid(${p.id})" title="Tandai Berhasil">
                         <i class="fas fa-check"></i>
                       </button>`
                    : `<button class="btn-icon" disabled style="opacity:.45;cursor:not-allowed;" title="Tidak tersedia">
                         <i class="fas fa-ban"></i>
                       </button>`
                }
              </div>
            </td>
          </tr>
        `;
      });
    }

    // ===== modal =====
    function setModalVisible(visible) {
      document.getElementById("detailModal").style.display = visible ? "flex" : "none";
    }

    window.openDetail = function(id) {
      const p = allPayments.find(x => Number(x.id) === Number(id));
      if (!p) return showAlert("Data pembayaran tidak ditemukan", "error");
      currentModalPayment = p;

      const st = statusBadge(p.status);
      const orderId = p.pesananId || p.pesanan?.id || "-";
      const userEmail = p.pesanan?.pengguna?.email || "-";
      const orderStatus = p.pesanan?.status || "-";

      document.getElementById("mPayId").textContent = "#" + (p.id || "-");
      document.getElementById("mOrderId").textContent = "#" + orderId;
      document.getElementById("mStatus").innerHTML = `<span class="badge ${st.class}">${st.text}</span>`;
      document.getElementById("mMetode").textContent = String(p.metode || "-");
      document.getElementById("mProvider").textContent = p.provider || "-";
      document.getElementById("mAmount").textContent = formatRupiah(p.amount);
      document.getElementById("mExpiredAt").textContent = formatDate(p.expiredAt);
      document.getElementById("mPaidAt").textContent = formatDate(p.paidAt);
      document.getElementById("mCreatedAt").textContent = formatDate(p.dibuatPada);
      document.getElementById("mUser").textContent = userEmail;
      document.getElementById("mOrderStatus").textContent = orderStatus;

      document.getElementById("mRaw").textContent =
        p.rawResponse ? JSON.stringify(p.rawResponse, null, 2) : "-";

      const btnConfirm = document.getElementById("btnConfirmPaid");
      const isMenunggu = String(p.status||"").toUpperCase() === "MENUNGGU";

      btnConfirm.disabled = !isMenunggu;
      btnConfirm.style.opacity = isMenunggu ? "1" : ".5";
      btnConfirm.style.cursor = isMenunggu ? "pointer" : "not-allowed";

      setModalVisible(true);
    };

    // ===== actions =====
    window.confirmPaid = async function(id) {
      if (!confirm("Konfirmasi pembayaran ini sebagai BERHASIL? (Pesanan akan otomatis menjadi DIPROSES)")) return;
      try {
        await apiRequest(`/api/admin/pembayaran/${id}/berhasil`, { method: "PATCH" });
        showAlert("Pembayaran dikonfirmasi. Pesanan masuk DIPROSES.", "success");
        setModalVisible(false);
        await loadPayments();
      } catch (e) {
        console.error(e);
        showAlert(e.message || "Gagal konfirmasi pembayaran", "error");
      }
    };

    // modal confirm button
    document.getElementById("btnConfirmPaid").addEventListener("click", () => {
      if (!currentModalPayment) return;
      confirmPaid(currentModalPayment.id);
    });

    // ===== wire events =====
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("searchId").addEventListener("input", e => {
        searchId = e.target.value || "";
      });

      document.getElementById("filterStatus").addEventListener("change", e => {
        filterStatus = e.target.value || "";
      });

      document.getElementById("filterTanggalDari").addEventListener("change", e => {
        filterTanggalDari = e.target.value || "";
      });

      document.getElementById("filterTanggalSampai").addEventListener("change", e => {
        filterTanggalSampai = e.target.value || "";
      });

      document.getElementById("btnApply").addEventListener("click", applyFilters);
      document.getElementById("btnReset").addEventListener("click", resetFilters);

      document.getElementById("btnRefresh").addEventListener("click", loadPayments);

      document.getElementById("btnCloseModal").addEventListener("click", () => setModalVisible(false));
      document.getElementById("btnModalClose2").addEventListener("click", () => setModalVisible(false));

      // close modal when click overlay
      document.getElementById("detailModal").addEventListener("click", (e) => {
        if (e.target.id === "detailModal") setModalVisible(false);
      });

      loadPayments();
    });
  </script>
</body>
</html>
