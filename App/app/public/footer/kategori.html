<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Semua Produk - Ashanum</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; color: #333; background: #f5f5f5; }

    .page-container {
      max-width: 1200px;
      margin: 20px auto 40px;
      padding: 0 5px;
    }

    .page-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px 20px;
      border-radius: 12px;
      margin-bottom: 30px;
      text-align: center;
    }

    .page-header h1 {
      font-size: 36px;
      margin-bottom: 10px;
    }

    .page-header p {
      font-size: 16px;
      opacity: 0.9;
    }

    .filters {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filter-item label {
      font-size: 14px;
      font-weight: 600;
      color: #666;
    }

    .filter-item select {
      padding: 10px 15px;
      border: 2px solid #e5e5e5;
      border-radius: 6px;
      font-size: 14px;
      min-width: 200px;
    }

    .product-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
    }

    .product-card {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid #eee;
    }

    .product-card:hover {
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      transform: translateY(-5px);
    }

    .product-image {
      width: 100%;
      height: 280px;
      background: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 80px;
      position: relative;
    }

    .product-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .discount-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #ff4081;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }

    .product-info {
      padding: 15px;
    }

    .product-name {
      font-size: 14px;
      margin-bottom: 10px;
      height: 35px;
      overflow: hidden;
    }

    .price-container {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
    }

    .current-price {
      font-size: 18px;
      font-weight: bold;
      color: #ff4081;
    }

    .original-price {
      font-size: 14px;
      color: #999;
      text-decoration: line-through;
    }

    .product-sold {
      font-size: 11px;
      color: #666;
    }

    @media (max-width: 1024px) {
      .product-grid { grid-template-columns: repeat(3, 1fr); }
    }

    @media (max-width: 768px) {
      .page-header h1 { font-size: 28px; }
      .product-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
      .filters { flex-direction: column; align-items: stretch; }
      .filter-item select { min-width: 100%; }
    }
  </style>
</head>
<body>
  <div id="header-container"></div>

  <div class="page-container">
    <div class="page-header">
      <h1>Semua Produk</h1>
      <p>Temukan berbagai produk berkualitas dengan harga terbaik</p>
    </div>

    <div class="filters">
      <div class="filter-item">
        <label>Kategori</label>
        <select id="filterKategori">
          <option value="">Semua Kategori</option>
        </select>
      </div>

      <div class="filter-item">
        <label>Urutkan</label>
        <select id="filterSort">
          <option value="terbaru">Terbaru</option>
          <option value="terlaris">Terlaris</option>
          <option value="termurah">Harga Termurah</option>
          <option value="termahal">Harga Termahal</option>
        </select>
      </div>
    </div>

    <div class="product-grid" id="productGrid">
      <!-- Products akan di-render di sini -->
    </div>
  </div>

  <div id="footer-container"></div>
  
  <script src="../assets/js/alert.js"></script>
  <script src="../assets/js/config.js"></script>
  <script src="../assets/js/helpersindex.js"></script>
  
  <script>
    fetch('../header.html').then(r => r.text()).then(h => {
      document.getElementById('header-container').innerHTML = h;
    });

    fetch('../footer.html').then(r => r.text()).then(h => {
      document.getElementById('footer-container').innerHTML = h;
    });

    let allProducts = [];

    async function loadProducts() {
      try {
        const products = await apiRequest("/api/produk");
        allProducts = (products || []).filter(p => p.aktif === true);
        renderProducts(allProducts);
        loadCategories();
      } catch (err) {
        console.error(err);
      }
    }

    async function loadCategories() {
      try {
        const categories = await apiRequest("/api/kategori");
        const select = document.getElementById('filterKategori');
        categories.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat.id;
          option.textContent = cat.nama;
          select.appendChild(option);
        });
      } catch (err) {
        console.error(err);
      }
    }

    function renderProducts(products) {
      const grid = document.getElementById('productGrid');
      grid.innerHTML = '';

      if (!products.length) {
        grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">Tidak ada produk</p>';
        return;
      }

      products.forEach(p => {
        const imageHtml = p.gambarUtama
          ? `<img src="${imgUrl(p.gambarUtama)}" alt="${p.nama}">`
          : `ðŸ“¦`;

        const diskonBadge = p.diskonPersen
          ? `<span class="discount-badge">-${p.diskonPersen}%</span>`
          : "";

        const original = p.hargaAsli
          ? `<span class="original-price">Rp ${rupiah(p.hargaAsli)}</span>`
          : "";

        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = `
          <div class="product-image">
            ${imageHtml}
            ${diskonBadge}
          </div>
          <div class="product-info">
            <div class="product-name">${escapeHtml(p.nama)}</div>
            <div class="price-container">
              <span class="current-price">Rp ${rupiah(p.harga)}</span>
              ${original}
            </div>
            <div class="product-sold">Terjual ${rupiah(p.terjual || 0)}</div>
          </div>
        `;

        card.onclick = () => window.location.href = `produk.html?id=${p.id}`;
        grid.appendChild(card);
      });
    }

    function rupiah(n) {
      return Number(n || 0).toLocaleString("id-ID");
    }

    function escapeHtml(str) {
      return String(str || "").replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;");
    }

    function imgUrl(u) {
      if (!u) return "";
      if (u.startsWith("http")) return u;
      return `${window.API_BASE}${u}`;
    }

    // Fungsi untuk apply filter dan sort bersamaan
    function applyFilters() {
      const kategoriId = document.getElementById('filterKategori').value;
      const sort = document.getElementById('filterSort').value;

      // Filter berdasarkan kategori
      let filtered = kategoriId
        ? allProducts.filter(p => String(p.kategoriId) === String(kategoriId))
        : [...allProducts];

      // Sort
      if (sort === 'terlaris') {
        filtered.sort((a, b) => (b.terjual || 0) - (a.terjual || 0));
      } else if (sort === 'termurah') {
        filtered.sort((a, b) => a.harga - b.harga);
      } else if (sort === 'termahal') {
        filtered.sort((a, b) => b.harga - a.harga);
      }
      // 'terbaru' tidak perlu sorting khusus, gunakan urutan default dari API

      renderProducts(filtered);
    }

    // Event listeners
    document.getElementById('filterKategori')?.addEventListener('change', applyFilters);
    document.getElementById('filterSort')?.addEventListener('change', applyFilters);

    document.addEventListener('DOMContentLoaded', loadProducts);
  </script>
</body>
</html>