<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pembayaran - Ashanum</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="/favicon.png?v=2">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #EE4D2D;
      --primary-light: #fff3f0;
      --primary-dark: #d43f20;
      --green: #26aa99;
      --green-light: #f0faf9;
      --orange: #f57224;
      --blue: #1890ff;
      --gray-50: #fafafa;
      --gray-100: #f5f5f5;
      --gray-200: #eeeeee;
      --gray-300: #e0e0e0;
      --gray-500: #9e9e9e;
      --gray-700: #616161;
      --gray-900: #212121;
      --text: #333;
      --text-light: #757575;
      --border: #e8e8e8;
      --radius: 8px;
      --shadow: 0 1px 4px rgba(0,0,0,0.08);
      --shadow-md: 0 2px 12px rgba(0,0,0,0.1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Nunito', sans-serif;
      background: #f5f5f5;
      color: var(--text);
      font-size: 14px;
    }

    .top-bar {
      background: #fff;
      border-bottom: 1px solid var(--border);
      padding: 0 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }
    .top-bar-inner {
      max-width: 1200px;
      margin: 0 auto;
      height: 56px;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .top-bar-divider { width: 1px; height: 28px; background: var(--border); }
    .top-bar-title { font-size: 16px; font-weight: 700; color: var(--gray-700); }
    .top-bar-steps { margin-left: auto; display: flex; align-items: center; gap: 6px; font-size: 13px; }
    .step { color: var(--gray-500); display: flex; align-items: center; gap: 5px; }
    .step.done { color: var(--gray-500); }
    .step.active { color: var(--primary); font-weight: 700; }
    .step i { font-size: 12px; }

    .page-wrapper {
      max-width: 1000px;
      margin: 20px auto 40px;
      padding: 0 16px;
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 16px;
      align-items: start;
    }

    .card { background: #fff; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 12px; overflow: hidden; }
    .card-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
    .card-header-icon { width: 32px; height: 32px; border-radius: 50%; background: var(--primary-light); display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 14px; }
    .card-header h3 { font-size: 15px; font-weight: 700; color: var(--gray-900); }
    .card-body { padding: 16px 20px; }

    .status-banner { background: #fff; border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; margin-bottom: 12px; display: flex; align-items: center; gap: 16px; }
    .status-icon-wrap { width: 56px; height: 56px; min-width: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; background: #fff7e6; }
    .status-icon-wrap.waiting { background: #fff7e6; }
    .status-icon-wrap.success { background: #f6ffed; }
    .status-icon-wrap.failed  { background: #fff2f0; }
    .status-icon-wrap.cod     { background: #f6ffed; }
    .status-text h2 { font-size: 17px; font-weight: 800; color: var(--gray-900); margin-bottom: 3px; }
    .status-text p  { font-size: 13px; color: var(--text-light); }
    .status-badge { margin-left: auto; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 700; white-space: nowrap; }
    .badge-waiting { background: #fff7e6; color: #d46b08; }
    .badge-success { background: #f6ffed; color: #389e0d; }
    .badge-failed  { background: #fff2f0; color: #cf1322; }
    .badge-cod     { background: #f6ffed; color: #389e0d; }

    .order-info-bar { background: var(--gray-50); border-top: 1px solid var(--border); padding: 12px 20px; display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
    .order-info-item { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--text-light); }
    .order-info-item strong { color: var(--gray-900); font-weight: 700; }
    .order-info-item i { color: var(--primary); font-size: 13px; }

    .payment-method-row { display: flex; align-items: center; gap: 14px; padding: 14px 0; }
    .pm-icon { width: 48px; height: 48px; min-width: 48px; border-radius: 10px; background: var(--primary-light); display: flex; align-items: center; justify-content: center; font-size: 22px; }
    .pm-info h4 { font-size: 15px; font-weight: 700; color: var(--gray-900); margin-bottom: 3px; }
    .pm-info p  { font-size: 13px; color: var(--text-light); }

    .midtrans-waiting { border: 2px dashed var(--primary); border-radius: var(--radius); padding: 20px; text-align: center; background: var(--primary-light); }
    .midtrans-waiting .mw-icon { font-size: 36px; margin-bottom: 10px; }
    .midtrans-waiting h4 { font-size: 15px; font-weight: 700; color: var(--primary-dark); margin-bottom: 6px; }
    .midtrans-waiting p  { font-size: 13px; color: var(--text-light); margin-bottom: 16px; }

    .btn-pay-now {
      background: var(--primary); color: #fff; border: none; border-radius: 6px;
      padding: 12px 28px; font-family: 'Nunito', sans-serif; font-size: 15px; font-weight: 700;
      cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px;
    }
    .btn-pay-now:hover { background: var(--primary-dark); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(238,77,45,0.3); }
    .btn-pay-now:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    .va-card { background: var(--gray-50); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; margin: 12px 0; }
    .va-label { font-size: 12px; color: var(--text-light); margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .va-row { display: flex; align-items: center; gap: 10px; background: #fff; border: 1px solid var(--border); border-radius: 6px; padding: 12px 14px; }
    .va-number { flex: 1; font-size: 20px; font-weight: 800; color: var(--primary); letter-spacing: 2px; font-family: 'Courier New', monospace; }
    .btn-copy { background: var(--primary-light); color: var(--primary); border: 1px solid var(--primary); border-radius: 5px; padding: 7px 14px; font-family: 'Nunito', sans-serif; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 5px; }
    .btn-copy:hover { background: var(--primary); color: #fff; }
    .btn-copy.copied { background: var(--green); border-color: var(--green); color: #fff; }

    .amount-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: var(--primary-light); border-radius: 6px; margin: 10px 0; }
    .amount-label { font-size: 13px; color: var(--text-light); font-weight: 600; }
    .amount-value { font-size: 20px; font-weight: 800; color: var(--primary); }

    .warn-box { background: #fffbe6; border-left: 3px solid #faad14; border-radius: 6px; padding: 10px 14px; margin: 10px 0; font-size: 13px; color: #7c5800; display: flex; align-items: flex-start; gap: 8px; }
    .warn-box i { color: #faad14; margin-top: 1px; flex-shrink: 0; }

    .how-to-pay { margin-top: 14px; }
    .how-to-title { font-size: 13px; font-weight: 700; color: var(--gray-700); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
    .step-item { display: flex; gap: 12px; margin-bottom: 10px; padding: 10px 12px; background: var(--gray-50); border-radius: 6px; }
    .step-num { width: 24px; height: 24px; min-width: 24px; border-radius: 50%; background: var(--primary); color: #fff; font-size: 12px; font-weight: 800; display: flex; align-items: center; justify-content: center; }
    .step-text h5 { font-size: 13px; font-weight: 700; margin-bottom: 2px; }
    .step-text p  { font-size: 12px; color: var(--text-light); }

    .cod-box { background: var(--green-light); border: 1px solid #b7eb8f; border-radius: var(--radius); padding: 16px; text-align: center; }
    .cod-box .cod-icon { font-size: 40px; margin-bottom: 8px; }
    .cod-box h4 { font-size: 16px; font-weight: 800; color: #237804; margin-bottom: 6px; }
    .cod-box p  { font-size: 13px; color: var(--text-light); }
    .cod-amount { margin-top: 14px; background: #fff; border-radius: 6px; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; }
    .cod-amount span   { font-size: 13px; color: var(--text-light); }
    .cod-amount strong { font-size: 20px; font-weight: 800; color: var(--primary); }
    .cod-steps { margin-top: 14px; text-align: left; }
    .cod-step-item { display: flex; align-items: flex-start; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 13px; color: var(--gray-700); }
    .cod-step-item:last-child { border-bottom: none; }
    .cod-step-item i { color: var(--green); margin-top: 2px; flex-shrink: 0; }

    .success-box { text-align: center; padding: 24px; }
    .success-box .s-icon { font-size: 56px; margin-bottom: 12px; }
    .success-box h4 { font-size: 18px; font-weight: 800; color: #237804; margin-bottom: 6px; }
    .success-box p  { font-size: 14px; color: var(--text-light); }

    .sidebar-card { background: #fff; border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; position: sticky; top: 76px; }
    .sidebar-header { padding: 14px 16px; border-bottom: 1px solid var(--border); font-size: 14px; font-weight: 700; color: var(--gray-900); display: flex; align-items: center; gap: 8px; }
    .sidebar-header i { color: var(--primary); }

    .product-item { display: flex; gap: 10px; padding: 12px 16px; border-bottom: 1px solid var(--border); }
    .product-img { width: 52px; height: 52px; min-width: 52px; border-radius: 6px; border: 1px solid var(--border); overflow: hidden; background: var(--gray-100); display: flex; align-items: center; justify-content: center; font-size: 24px; }
    .product-img img { width: 100%; height: 100%; object-fit: cover; }
    .product-detail { flex: 1; }
    .product-name { font-size: 13px; font-weight: 600; color: var(--gray-900); margin-bottom: 3px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .product-variant { font-size: 12px; color: var(--text-light); margin-bottom: 4px; }
    .product-price-row { display: flex; align-items: center; justify-content: space-between; }
    .product-price { font-size: 14px; font-weight: 800; color: var(--primary); }
    .product-qty   { font-size: 12px; color: var(--text-light); }

    .summary-rows { padding: 12px 16px; }
    .sum-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; font-size: 13px; }
    .sum-row .lbl { color: var(--text-light); }
    .sum-row .val { font-weight: 700; color: var(--gray-900); }
    .sum-row .val.green { color: var(--green); }
    .sum-total { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: var(--primary-light); border-top: 1px solid #ffd8cc; }
    .sum-total .tl { font-size: 14px; font-weight: 700; color: var(--gray-900); }
    .sum-total .tv { font-size: 20px; font-weight: 800; color: var(--primary); }

    .action-row { padding: 14px 16px; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 8px; }
    .btn-home {
      width: 100%; padding: 10px; border: 1.5px solid var(--border); background: #fff; color: var(--gray-700);
      border-radius: 6px; font-family: 'Nunito', sans-serif; font-size: 13px; font-weight: 700;
      cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    .btn-home:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }
    .btn-check {
      width: 100%; padding: 10px; border: none; background: var(--gray-100); color: var(--gray-700);
      border-radius: 6px; font-family: 'Nunito', sans-serif; font-size: 13px; font-weight: 700;
      cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    .btn-check:hover { background: var(--gray-200); }

    .ship-info { padding: 12px 16px; border-top: 1px solid var(--border); }
    .ship-label { font-size: 12px; color: var(--text-light); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
    .ship-value { font-size: 13px; font-weight: 700; color: var(--gray-900); margin-bottom: 2px; }
    .ship-addr  { font-size: 12px; color: var(--text-light); line-height: 1.6; white-space: pre-line; }

    .help-row { padding: 12px 16px; border-top: 1px solid var(--border); display: flex; gap: 8px; }
    .help-btn { flex: 1; padding: 8px 6px; border: 1px solid var(--border); background: #fff; border-radius: 6px; font-family: 'Nunito', sans-serif; font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 4px; color: var(--gray-700); }
    .help-btn:hover { border-color: var(--primary); color: var(--primary); }

    /* ===== PAYMENT LOADING OVERLAY ===== */
    .payment-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.55);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(3px);
      -webkit-backdrop-filter: blur(3px);
    }
    .payment-overlay-box {
      background: #fff;
      border-radius: 16px;
      padding: 40px 52px;
      text-align: center;
      box-shadow: 0 8px 40px rgba(0,0,0,0.18);
      min-width: 260px;
    }
    .payment-overlay-spinner {
      width: 52px; height: 52px;
      border: 5px solid #f0f0f0;
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      animation: overlaySpinAnim 0.8s linear infinite;
      margin: 0 auto 18px;
    }
    @keyframes overlaySpinAnim { to { transform: rotate(360deg); } }
    .payment-overlay-icon { font-size: 48px; margin-bottom: 14px; }
    .payment-overlay-title { font-size: 16px; font-weight: 800; color: var(--gray-900); margin-bottom: 6px; }
    .payment-overlay-sub   { font-size: 13px; color: var(--text-light); }

    @media (max-width: 768px) {
      .page-wrapper { grid-template-columns: 1fr; }
      .sidebar-card { position: static; order: -1; }
      .top-bar-steps { display: none; }
      .payment-overlay-box { padding: 32px 28px; margin: 0 20px; }
    }
  </style>
</head>
<body>
  <div id="header-container"></div>

  <div class="top-bar">
    <div class="top-bar-inner">
      <div class="top-bar-divider"></div>
      <span class="top-bar-title">Pembayaran</span>
      <div class="top-bar-steps">
        <span class="step done"><i class="fas fa-check-circle"></i> Keranjang</span>
        <i class="fas fa-chevron-right" style="color:#ccc;font-size:11px;"></i>
        <span class="step done"><i class="fas fa-check-circle"></i> Checkout</span>
        <i class="fas fa-chevron-right" style="color:#ccc;font-size:11px;"></i>
        <span class="step active"><i class="fas fa-circle"></i> Pembayaran</span>
      </div>
    </div>
  </div>

  <!-- ===== PAYMENT LOADING OVERLAY ===== -->
  <div class="payment-overlay" id="paymentOverlay" style="display:none;">
    <div class="payment-overlay-box">
      <div id="overlaySpinner" class="payment-overlay-spinner"></div>
      <div id="overlayIcon" class="payment-overlay-icon" style="display:none;"></div>
      <div class="payment-overlay-title" id="overlayTitle">Memuat Pembayaran...</div>
      <div class="payment-overlay-sub"   id="overlaySub">Mohon tunggu sebentar</div>
    </div>
  </div>

  <div class="page-wrapper">
    <div class="left-col">

      <div class="status-banner" id="statusBanner">
        <div class="status-icon-wrap waiting" id="statusIconWrap">
          <span id="statusEmoji">‚è≥</span>
        </div>
        <div class="status-text">
          <h2 id="statusTitle">Menunggu Pembayaran</h2>
          <p id="statusSubtitle">Selesaikan pembayaran untuk memproses pesanan Anda</p>
        </div>
        <span class="status-badge badge-waiting" id="statusBadge">Belum Dibayar</span>
      </div>

      <div class="card" style="margin-bottom:12px;">
        <div class="order-info-bar">
          <div class="order-info-item">
            <i class="fas fa-receipt"></i>
            <span>No. Pesanan: <strong id="orderId">...</strong></span>
          </div>
          <div class="order-info-item">
            <i class="fas fa-calendar"></i>
            <span id="orderDate">-</span>
          </div>
          <div class="order-info-item" id="orderStatusItem">
            <i class="fas fa-clock"></i>
            <span id="orderStatusText">Menunggu Pembayaran</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-header-icon"><i class="fas fa-credit-card"></i></div>
          <h3>Metode Pembayaran</h3>
        </div>
        <div class="card-body">
          <div class="payment-method-row">
            <div class="pm-icon" id="pmIcon">üí≥</div>
            <div class="pm-info">
              <h4 id="pmName">-</h4>
              <p id="pmDesc">-</p>
            </div>
          </div>

          <!-- ONLINE/Midtrans -->
          <div id="onlineSection" style="display:none;">
            <div class="midtrans-waiting" id="midtransWaiting">
              <div class="mw-icon">üîí</div>
              <h4>Selesaikan Pembayaran</h4>
              <p>Klik tombol di bawah untuk membuka halaman pembayaran Midtrans.</p>
              <button class="btn-pay-now" id="btnPayNow" onclick="openMidtrans()">
                <i class="fas fa-lock"></i> Bayar Sekarang
              </button>
              <div style="margin-top:12px;">
                <button onclick="cancelAndReorder()" style="background:none;border:none;color:#999;font-size:13px;cursor:pointer;font-family:'Nunito',sans-serif;text-decoration:underline;">
                  Batalkan & Ganti Metode Pembayaran
                </button>
              </div>
            </div>
            <div class="success-box" id="onlineSuccess" style="display:none;">
              <div class="s-icon">‚úÖ</div>
              <h4>Pembayaran Berhasil!</h4>
              <p>Pesanan Anda sedang diproses. Terima kasih telah berbelanja di Ashanum!</p>
            </div>
          </div>

          <!-- VA -->
          <div id="vaSection" style="display:none;">
            <div class="va-card">
              <div class="va-label">Nomor Virtual Account</div>
              <div class="va-row">
                <div class="va-number" id="vaNumber">---- ---- ---- ----</div>
                <button class="btn-copy" id="copyVaBtn" onclick="copyToClipboard(document.getElementById('vaNumber').textContent.replace(/\s/g,''), 'copyVaBtn')">
                  <i class="fas fa-copy"></i> Salin
                </button>
              </div>
            </div>
            <div class="amount-row">
              <span class="amount-label">Total Transfer</span>
              <div style="display:flex;align-items:center;gap:10px;">
                <span class="amount-value" id="vaAmount">Rp 0</span>
                <button class="btn-copy" id="copyAmountBtn"><i class="fas fa-copy"></i> Salin</button>
              </div>
            </div>
            <div class="warn-box">
              <i class="fas fa-exclamation-triangle"></i>
              <span>Transfer dengan nominal <strong>PERSIS SAMA</strong> agar pembayaran terverifikasi otomatis.</span>
            </div>
            <div class="how-to-pay">
              <div class="how-to-title"><i class="fas fa-info-circle" style="color:var(--primary)"></i> Cara Pembayaran</div>
              <div id="bankSteps"></div>
            </div>
          </div>

          <!-- COD -->
          <div id="codSection" style="display:none;">
            <div class="cod-box">
              <div class="cod-icon">üè™</div>
              <h4>Pesanan Dikonfirmasi!</h4>
              <p>Siapkan uang tunai saat kurir tiba di lokasi Anda.</p>
              <div class="cod-amount">
                <span>Total yang dibayar saat tiba</span>
                <strong id="codTotalAmount">Rp 0</strong>
              </div>
            </div>
            <div class="cod-steps">
              <div class="cod-step-item"><i class="fas fa-check-circle"></i> Pembayaran dilakukan saat barang tiba di lokasi</div>
              <div class="cod-step-item"><i class="fas fa-check-circle"></i> Periksa kondisi paket sebelum membayar</div>
              <div class="cod-step-item"><i class="fas fa-check-circle"></i> Minta bukti pembayaran dari kurir</div>
              <div class="cod-step-item"><i class="fas fa-check-circle"></i> Kurir membawa seragam dan ID card resmi</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-header-icon"><i class="fas fa-truck"></i></div>
          <h3>Info Pengiriman</h3>
        </div>
        <div class="ship-info">
          <div class="ship-label">Metode Pengiriman</div>
          <div class="ship-value" id="shippingMethod">-</div>
        </div>
        <div class="ship-info" style="border-top:1px solid var(--border);">
          <div class="ship-label">Alamat Tujuan</div>
          <div class="ship-value" id="recipientName">-</div>
          <div class="ship-addr" id="shippingAddress">-</div>
        </div>
      </div>

    </div>

    <div class="right-col">
      <div class="sidebar-card">
        <div class="sidebar-header">
          <i class="fas fa-shopping-bag"></i>
          Ringkasan Pesanan
        </div>
        <div id="productList"></div>
        <div class="summary-rows">
          <div class="sum-row">
            <span class="lbl">Subtotal Produk</span>
            <span class="val" id="subtotalValue">Rp 0</span>
          </div>
          <div class="sum-row">
            <span class="lbl">Ongkos Kirim</span>
            <span class="val" id="shippingValue">GRATIS</span>
          </div>
          <div class="sum-row" id="voucherRow" style="display:none;">
            <span class="lbl">Voucher Diskon</span>
            <span class="val green" id="voucherValue">-Rp 0</span>
          </div>
        </div>
        <div class="sum-total">
          <span class="tl">Total Pembayaran</span>
          <span class="tv" id="totalValue">Rp 0</span>
        </div>
        <div class="action-row">
          <button class="btn-check" id="checkStatusBtn" onclick="checkPaymentStatus()">
            <i class="fas fa-sync"></i> Cek Status Pembayaran
          </button>
          <button class="btn-home" onclick="window.location.href='/'">
            <i class="fas fa-home"></i> Kembali ke Beranda
          </button>
        </div>
        <div class="help-row">
          <button class="help-btn" onclick="contactWhatsApp()">
            <i class="fab fa-whatsapp" style="color:#25d366;"></i> WA
          </button>
          <button class="help-btn" onclick="contactEmail()">
            <i class="fas fa-envelope" style="color:var(--primary);"></i> Email
          </button>
          <button class="help-btn" onclick="openLiveChat()">
            <i class="fas fa-comment-dots" style="color:var(--blue);"></i> Chat
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="footer-container"></div>

  <script src="assets/js/alert.js"></script>
  <script src="assets/js/config.js"></script>
  <script src="assets/js/helpers.js"></script>

  <script>
    // ===== PAYMENT OVERLAY HELPERS =====
    function showPaymentLoading(title = "Memuat Pembayaran...", sub = "Mohon tunggu sebentar") {
      document.getElementById("overlaySpinner").style.display = "block";
      document.getElementById("overlayIcon").style.display    = "none";
      document.getElementById("overlayTitle").textContent = title;
      document.getElementById("overlaySub").textContent   = sub;
      document.getElementById("paymentOverlay").style.display = "flex";
    }
    function hidePaymentLoading() {
      document.getElementById("paymentOverlay").style.display = "none";
    }

    // ===== HELPERS =====
    function getVariantAttributesFromDb(varian) {
      const out = [], maps = varian?.atribut || [];
      for (const m of maps) {
        const label = m?.nilai?.atribut?.nama, value = m?.nilai?.nilai;
        if (label && value) out.push({ label, value });
      }
      return out;
    }
    function normalizeBankFromProvider(provider) {
      const p = String(provider || "").toLowerCase();
      if (p.includes("bca")) return "bca";
      if (p.includes("bni")) return "bni";
      if (p.includes("mandiri")) return "mandiri";
      return "bca";
    }
    function formatVANumber(va) {
      const s = String(va || "").replace(/\s+/g, "");
      if (!s) return "---- ---- ---- ----";
      return (s.match(/.{1,4}/g) || [s]).join(" ");
    }
    function prettyPaymentName(pembayaran) {
      if (!pembayaran) return "-";
      const metode = String(pembayaran.metode || "").toUpperCase();
      const provider = String(pembayaran.provider || "");
      if (metode === "COD")     return "COD (Bayar di Tempat)";
      if (metode === "ONLINE")  return "Bayar Online (Midtrans)";
      if (metode === "EWALLET") return provider || "E-Wallet";
      if (provider) return provider.replaceAll("_", " ");
      return "Virtual Account";
    }
    function pmIcon(pembayaran) {
      const m = String(pembayaran?.metode || "").toUpperCase();
      if (m === "COD")     return "üè™";
      if (m === "EWALLET") return "üì±";
      if (m === "ONLINE")  return "üîí";
      return "üí≥";
    }
    function copyToClipboard(text, btnId) {
      navigator.clipboard.writeText(String(text || "")).then(() => {
        const btn = document.getElementById(btnId), orig = btn.innerHTML;
        btn.classList.add("copied");
        btn.innerHTML = '<i class="fas fa-check"></i> Tersalin!';
        setTimeout(() => { btn.classList.remove("copied"); btn.innerHTML = orig; }, 2000);
      }).catch(err => alert("Gagal menyalin: " + err));
    }

    // ===== BANK STEPS =====
    const bankStepsData = {
      bca: [
        { t: "Buka M-Banking / ATM BCA", d: "Login ke BCA Mobile atau datangi ATM BCA terdekat" },
        { t: "Pilih Virtual Account Billing", d: 'Pilih "Virtual Account Billing"' },
        { t: "Masukkan Nomor VA", d: "Ketik nomor VA yang tertera di atas" },
        { t: "Periksa & Konfirmasi", d: "Pastikan nama dan nominal sudah benar" },
        { t: "Simpan Bukti Bayar", d: "Screenshot atau cetak struk sebagai bukti" },
      ],
      bni: [
        { t: "Buka BNI Mobile / ATM", d: "Login ke BNI Mobile Banking atau ATM BNI" },
        { t: "Pilih Transfer ‚Üí Virtual Account", d: "Pilih menu Virtual Account Billing" },
        { t: "Input Nomor VA", d: "Masukkan nomor VA yang diberikan" },
        { t: "Konfirmasi Pembayaran", d: "Cek detail, masukkan PIN untuk konfirmasi" },
        { t: "Simpan Bukti", d: "Simpan bukti transaksi Anda" },
      ],
      mandiri: [
        { t: "Buka Livin' by Mandiri", d: "Login ke aplikasi Livin' atau ATM Mandiri" },
        { t: "Pilih Bayar ‚Üí Multipayment", d: 'Cari menu "Multipayment" atau "Virtual Account"' },
        { t: "Masukkan Nomor VA", d: "Ketik nomor VA yang tertera" },
        { t: "Konfirmasi Nominal", d: "Pastikan jumlah pembayaran sudah sesuai" },
        { t: "Simpan Bukti", d: "Simpan notifikasi atau struk sebagai bukti" },
      ],
    };
    function renderBankSteps(bankCode) {
      const steps = bankStepsData[bankCode] || bankStepsData.bca;
      document.getElementById("bankSteps").innerHTML = steps.map((s, i) => `
        <div class="step-item">
          <div class="step-num">${i + 1}</div>
          <div class="step-text"><h5>${escapeHtml(s.t)}</h5><p>${escapeHtml(s.d)}</p></div>
        </div>`).join("");
    }

    // ===== STATUS UI =====
    function setStatusUI(pembayaran, isCOD) {
      const status   = String(pembayaran?.status || "MENUNGGU").toUpperCase();
      const iconWrap = document.getElementById("statusIconWrap");
      const emoji    = document.getElementById("statusEmoji");
      const title    = document.getElementById("statusTitle");
      const subtitle = document.getElementById("statusSubtitle");
      const badge    = document.getElementById("statusBadge");

      iconWrap.className = "status-icon-wrap";
      badge.className    = "status-badge";

      if (isCOD) {
        iconWrap.classList.add("cod"); emoji.textContent = "‚úÖ";
        title.textContent = "Pesanan Dikonfirmasi"; subtitle.textContent = "Pembayaran dilakukan saat barang tiba";
        badge.textContent = "COD"; badge.classList.add("badge-cod");
        document.getElementById("checkStatusBtn").style.display = "none";
        return;
      }
      if (status === "BERHASIL") {
        iconWrap.classList.add("success"); emoji.textContent = "‚úÖ";
        title.textContent = "Pembayaran Berhasil!"; subtitle.textContent = "Pesanan Anda sedang diproses oleh penjual";
        badge.textContent = "Lunas"; badge.classList.add("badge-success");
        document.getElementById("checkStatusBtn").style.display = "none";
        return;
      }
      if (status === "KADALUARSA" || status === "GAGAL") {
        iconWrap.classList.add("failed");
        emoji.textContent = status === "KADALUARSA" ? "‚åõ" : "‚ùå";
        title.textContent = status === "KADALUARSA" ? "Pembayaran Kadaluarsa" : "Pembayaran Gagal";
        subtitle.textContent = "Silakan buat pesanan baru";
        badge.textContent = status === "KADALUARSA" ? "Kadaluarsa" : "Gagal";
        badge.classList.add("badge-failed");
        return;
      }
      iconWrap.classList.add("waiting"); emoji.textContent = "‚è≥";
      title.textContent = "Menunggu Pembayaran"; subtitle.textContent = "Selesaikan pembayaran untuk memproses pesanan";
      badge.textContent = "Belum Dibayar"; badge.classList.add("badge-waiting");
    }

    // ===== RENDER PRODUCTS =====
    function renderProducts(items) {
      const el = document.getElementById("productList");
      if (!items?.length) { el.innerHTML = '<p style="padding:14px 16px;color:#999;font-size:13px;">Tidak ada produk</p>'; return; }
      el.innerHTML = items.map((it) => {
        const nama = escapeHtml(it.produk?.nama || "Produk");
        const qty  = Number(it.jumlah || 1);
        const harga = Number(it.harga ?? it.varian?.harga ?? it.produk?.harga ?? 0);
        const attrs = getVariantAttributesFromDb(it.varian);
        const variantText = attrs.map(a => `${escapeHtml(a.label)}: ${escapeHtml(a.value)}`).join(", ");
        const gambar = it.produk?.gambarUtama ? toAbsoluteUrl(it.produk.gambarUtama) : "";
        return `<div class="product-item">
          <div class="product-img">${gambar ? `<img src="${gambar}" alt="${nama}">` : "üì¶"}</div>
          <div class="product-detail">
            <div class="product-name">${nama}</div>
            ${variantText ? `<div class="product-variant">${variantText}</div>` : ""}
            <div class="product-price-row">
              <span class="product-price">${rupiah(harga)}</span>
              <span class="product-qty">x${qty}</span>
            </div>
          </div>
        </div>`;
      }).join("");
    }

    // ===== RENDER PAYMENT BLOCKS =====
    function renderPaymentBlocks(pesanan) {
      const pembayaran = pesanan.pembayaran || {};
      const metode     = String(pembayaran.metode || "").toUpperCase();

      document.getElementById("pmIcon").textContent = pmIcon(pembayaran);
      document.getElementById("pmName").textContent = prettyPaymentName(pembayaran);
      document.getElementById("onlineSection").style.display = "none";
      document.getElementById("vaSection").style.display     = "none";
      document.getElementById("codSection").style.display    = "none";

      if (metode === "ONLINE") {
        document.getElementById("pmDesc").textContent = "Transfer Bank ¬∑ VA ¬∑ GoPay ¬∑ OVO ¬∑ QRIS ¬∑ Kartu Kredit";
        document.getElementById("onlineSection").style.display = "block";
        if (String(pembayaran.status || "").toUpperCase() === "BERHASIL") {
          document.getElementById("midtransWaiting").style.display = "none";
          document.getElementById("onlineSuccess").style.display   = "block";
        }
        return;
      }
      if (metode === "VA" || metode === "TRANSFER" || metode === "") {
        document.getElementById("pmDesc").textContent = "Transfer Bank Virtual Account";
        document.getElementById("vaSection").style.display = "block";
        document.getElementById("vaNumber").textContent = formatVANumber(pembayaran.vaNumber || "");
        document.getElementById("vaAmount").textContent = rupiah(pembayaran.amount ?? pesanan.totalAkhir ?? 0);
        document.getElementById("copyAmountBtn").onclick = () =>
          copyToClipboard(String(pembayaran.amount ?? pesanan.totalAkhir ?? 0), "copyAmountBtn");
        renderBankSteps(normalizeBankFromProvider(pembayaran.provider));
        return;
      }
      if (metode === "COD") {
        document.getElementById("pmDesc").textContent = "Bayar Tunai saat Barang Tiba";
        document.getElementById("codSection").style.display = "block";
        document.getElementById("codTotalAmount").textContent = rupiah(pesanan.totalAkhir ?? 0);
        setStatusUI(pembayaran, true);
        return;
      }
      document.getElementById("pmDesc").textContent = "Silakan ikuti instruksi pembayaran";
    }

    function makeOrderNumber(pesanan) {
      const d = new Date(pesanan.dibuatPada || pesanan.createdAt || Date.now());
      return `INV-${String(d.getFullYear()).slice(2)}${String(d.getMonth()+1).padStart(2,"0")}${String(d.getDate()).padStart(2,"0")}-${String(pesanan.id??"").padStart(5,"0")}`;
    }

    // ===== RENDER ORDER =====
    function renderOrderData(pesanan) {
      document.getElementById("orderId").textContent = makeOrderNumber(pesanan);
      const d = new Date(pesanan.dibuatPada || pesanan.createdAt || Date.now());
      document.getElementById("orderDate").textContent =
        d.toLocaleDateString("id-ID", { day:"numeric", month:"short", year:"numeric" }) + ", " +
        d.toLocaleTimeString("id-ID", { hour:"2-digit", minute:"2-digit" });

      const layanan = pesanan.pengiriman?.layanan, kurir = layanan?.kurir;
      document.getElementById("shippingMethod").textContent = layanan
        ? `${layanan.nama}${kurir ? ` (${kurir.nama || kurir.kode})` : ""} ¬∑ Est. ${layanan.estimasiHari} hari` : "-";
      document.getElementById("recipientName").textContent = `${pesanan.namaPenerima||"-"} ¬∑ ${pesanan.noTelp||"-"}`;
      document.getElementById("shippingAddress").textContent = [
        pesanan.alamat || "-",
        `Kel. ${pesanan.kelurahan||"-"}, Kec. ${pesanan.kecamatan||"-"}`,
        `${pesanan.kota||"-"}, ${pesanan.provinsi||"-"} ${pesanan.kodePos||"-"}`,
      ].join("\n");

      document.getElementById("subtotalValue").textContent = rupiah(pesanan.subtotal ?? 0);
      document.getElementById("shippingValue").textContent = (pesanan.ongkir??0) > 0 ? rupiah(pesanan.ongkir) : "GRATIS";
      const diskon = Number(pesanan.diskon ?? 0);
      if (diskon > 0) {
        document.getElementById("voucherRow").style.display = "flex";
        document.getElementById("voucherValue").textContent = "-" + rupiah(diskon);
      }
      document.getElementById("totalValue").textContent = rupiah(pesanan.totalAkhir ?? 0);

      renderProducts(pesanan.item || []);
      setStatusUI(pesanan.pembayaran, false);
      renderPaymentBlocks(pesanan);
    }

    // ===== SNAP POPUP =====
    function triggerSnapPopup(snapToken) {
      let pollingInterval = null;

      function startPolling() {
        pollingInterval = setInterval(async () => {
          try {
            const res = await apiAuth(`/api/pembayaran/${currentOrderId}/konfirmasi`, { method: "POST" });
            if (res?.status === "BERHASIL") {
              clearInterval(pollingInterval);
              const overlay = document.getElementById("snap-midtrans")
                || document.querySelector("iframe[src*='midtrans']")?.closest("div");
              if (overlay) overlay.style.display = "none";
              await loadOrderData();
              showAlert("‚úÖ Pembayaran berhasil! Pesanan sedang diproses.", "success");
            }
          } catch (e) { /* abaikan error polling */ }
        }, 5000);
      }

      function stopPolling() {
        if (pollingInterval) { clearInterval(pollingInterval); pollingInterval = null; }
      }

      const doPay = () => {
        hidePaymentLoading(); // ‚úÖ Sembunyikan loading tepat sebelum popup muncul
        startPolling();

        window.snap.pay(snapToken, {
          onSuccess: async function (result) {
            stopPolling();
            console.log("‚úÖ Snap onSuccess:", result);
            showPaymentLoading("Memverifikasi Pembayaran...", "Mohon tunggu sebentar");
            try {
              await apiAuth(`/api/pembayaran/${currentOrderId}/konfirmasi`, { method: "POST" });
            } catch (e) {
              console.warn("‚ö†Ô∏è Konfirmasi gagal:", e.message);
            }
            await loadOrderData();
            hidePaymentLoading();
          },
          onPending: function () {
            stopPolling();
            loadOrderData();
          },
          onError: function () {
            stopPolling();
            hidePaymentLoading();
            alert("Pembayaran gagal. Silakan coba lagi.");
          },
          onClose: async function () {
            stopPolling();
            try {
              const res = await apiAuth(`/api/pembayaran/${currentOrderId}/konfirmasi`, { method: "POST" });
              await loadOrderData();
              if (res?.status === "BERHASIL") {
                showAlert("‚úÖ Pembayaran berhasil!", "success");
              }
            } catch (e) {
              console.warn("Cek status setelah close gagal:", e.message);
              await loadOrderData();
            }
          },
        });
      };

      if (window.snap) {
        doPay();
      } else {
        // SDK belum siap ‚Äî tunggu event snapReady
        window.addEventListener("snapReady", doPay, { once: true });
        setTimeout(() => {
          if (!window.snap) {
            window.removeEventListener("snapReady", doPay);
            hidePaymentLoading();
            alert("Midtrans SDK gagal dimuat. Refresh halaman.");
          }
        }, 15000);
      }
    }

    // ===== OPEN MIDTRANS =====
    window.openMidtrans = async function () {
      const btn = document.getElementById("btnPayNow");
      try {
        btn.disabled  = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memuat...';
        showPaymentLoading("Memuat Pembayaran...", "Menghubungkan ke Midtrans");

        const res = await apiAuth(`/api/pembayaran/${encodeURIComponent(currentOrderId)}/bayar`, { method: "POST" });

        if (res.alreadyPaid) {
          hidePaymentLoading();
          await loadOrderData();
          showAlert("‚úÖ Pembayaran sudah berhasil!", "success");
          return;
        }

        if (res.snapToken) {
          showPaymentLoading("Membuka Halaman Pembayaran...", "Popup akan muncul sebentar lagi");
          // triggerSnapPopup akan memanggil hidePaymentLoading() saat popup siap
          triggerSnapPopup(res.snapToken);
        } else {
          hidePaymentLoading();
          alert("Gagal mendapatkan token pembayaran.");
        }
      } catch (e) {
        hidePaymentLoading();
        alert(e.message || "Gagal");
      } finally {
        btn.disabled  = false;
        btn.innerHTML = '<i class="fas fa-lock"></i> Bayar Sekarang';
      }
    };

    // ===== STATE =====
    let currentOrderId = null;
    let autoTriggered  = false;

    function getOrderIdFromUrl() {
      const p = new URLSearchParams(window.location.search);
      return p.get("orderId") || p.get("pesananId");
    }

    // ===== LOAD ORDER =====
    async function loadOrderData() {
      const orderId = getOrderIdFromUrl();
      if (!orderId) { alert("Order ID tidak ditemukan"); window.location.href = "/"; return; }
      currentOrderId = orderId;

      // Hapus ?auto dari URL SEBELUM apapun agar polling tidak re-trigger
      const params     = new URLSearchParams(window.location.search);
      const shouldAuto = !autoTriggered && params.get("auto") === "1";
      if (shouldAuto) {
        const newUrl = new URL(window.location.href);
        newUrl.searchParams.delete("auto");
        window.history.replaceState({}, "", newUrl.toString());
        autoTriggered = true;
      }

      const pesanan = await apiAuth(`/api/pesanan/${encodeURIComponent(orderId)}`, { method: "GET" });
      renderOrderData(pesanan);

      const isOnline       = String(pesanan?.pembayaran?.metode  || "").toUpperCase() === "ONLINE";
      const statusBelumBayar = String(pesanan?.pembayaran?.status || "").toUpperCase() === "MENUNGGU";

      if (shouldAuto && isOnline && statusBelumBayar) {
        // Tampilkan loading saat auto-open dari checkout
        showPaymentLoading("Memuat Pembayaran...", "Menghubungkan ke Midtrans");
        setTimeout(() => openMidtrans(), 600);
      }

      return pesanan;
    }

    // ===== CEK STATUS =====
    window.checkPaymentStatus = async function () {
      const btn = document.getElementById("checkStatusBtn");
      try {
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengecek...';
        btn.disabled  = true;
        const pesanan = await apiAuth(`/api/pesanan/${encodeURIComponent(currentOrderId)}`, { method: "GET" });
        renderOrderData(pesanan);
        const status = String(pesanan?.pembayaran?.status || "MENUNGGU").toUpperCase();
        if (status === "BERHASIL") showAlert("‚úÖ Pembayaran berhasil! Pesanan sedang diproses.", "success");
        else showAlert(`Status: ${status}`, "info");
      } catch (err) {
        if (String(err.message) === "NO_LOGIN") return;
        showAlert(err.message || "Gagal cek status", "error");
      } finally {
        btn.disabled  = false;
        btn.innerHTML = '<i class="fas fa-sync"></i> Cek Status Pembayaran';
      }
    };

    window.contactWhatsApp = function () {
      window.open(`https://wa.me/628123456789?text=${encodeURIComponent("Halo, butuh bantuan Order ID: " + (currentOrderId||"-"))}`, "_blank");
    };
    window.contactEmail  = function () { window.location.href = `mailto:support@ashanum.com?subject=Bantuan Pembayaran - ${currentOrderId||"-"}`; };
    window.openLiveChat  = function () { alert("Live chat akan segera dibuka"); };

    // ===== BATAL & GANTI =====
    window.cancelAndReorder = async function () {
      if (!confirm("Pesanan ini akan dibatalkan dan Anda kembali ke keranjang.\n\nLanjutkan?")) return;
      try {
        await apiAuth(`/api/pesanan/${encodeURIComponent(currentOrderId)}/batal`, { method: "PATCH" });
        showAlert("Pesanan dibatalkan. Silakan buat pesanan baru.", "info");
        setTimeout(() => window.location.href = "/keranjang.html", 1500);
      } catch (e) {
        showAlert("Silakan buat pesanan baru untuk ganti metode pembayaran.", "info");
        setTimeout(() => window.location.href = "/keranjang.html", 1500);
      }
    };

    // ===== INIT =====
    document.addEventListener("DOMContentLoaded", () => {
      loadOrderData().catch((err) => {
        if (String(err.message) === "NO_LOGIN") return;
        console.error(err);
        alert(err.message || "Gagal memuat data pesanan");
      });
    });
  </script>

</body>
</html>