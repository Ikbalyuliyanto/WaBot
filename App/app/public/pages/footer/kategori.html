<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Semua Produk - Ashanum</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="/favicon.png?v=2">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; color: #333; background: #f5f5f5; }

    .page-container {
      max-width: 1200px;
      margin: 20px auto 40px;
      padding: 0 5px;
    }

    .page-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px 20px;
      border-radius: 12px;
      margin-bottom: 30px;
      text-align: center;
    }

    .page-header h1 {
      font-size: 36px;
      margin-bottom: 10px;
    }

    .page-header p {
      font-size: 16px;
      opacity: 0.9;
    }

    .filters {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filter-item label {
      font-size: 14px;
      font-weight: 600;
      color: #666;
    }

    .filter-item select {
      padding: 10px 15px;
      border: 2px solid #e5e5e5;
      border-radius: 6px;
      font-size: 14px;
      min-width: 200px;
    }

    .product-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
    }

    .product-card {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid #eee;
    }

    .product-card:hover {
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      transform: translateY(-5px);
    }

    .product-image {
      width: 100%;
      height: 280px;
      background: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 80px;
      position: relative;
    }

    .product-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .discount-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #ff4081;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }

    .product-info {
      padding: 15px;
    }

    .product-name {
      font-size: 14px;
      margin-bottom: 10px;
      height: 35px;
      overflow: hidden;
    }

    .price-container {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
    }

    .current-price {
      font-size: 18px;
      font-weight: bold;
      color: #ff4081;
    }

    .original-price {
      font-size: 14px;
      color: #999;
      text-decoration: line-through;
    }

    .product-sold {
      font-size: 11px;
      color: #666;
    }

    @media (max-width: 1024px) {
      .product-grid { grid-template-columns: repeat(3, 1fr); }
    }

    @media (max-width: 768px) {
      .page-header h1 { font-size: 28px; }
      .product-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
      .filters { flex-direction: column; align-items: stretch; }
      .filter-item select { min-width: 100%; }
    }
  </style>
</head>
<body>
  <div id="header-container"></div>

  <div class="page-container">
    <div class="page-header">
      <h1>Semua Produk</h1>
      <p>Temukan berbagai produk berkualitas dengan harga terbaik</p>
    </div>

    <div class="filters">
      <div class="filter-item">
        <label>Kategori</label>
        <select id="filterKategori">
          <option value="">Semua Kategori</option>
        </select>
      </div>

      <div class="filter-item">
        <label>Urutkan</label>
        <select id="filterSort">
          <option value="terbaru">Terbaru</option>
          <option value="terlaris">Terlaris</option>
          <option value="termurah">Harga Termurah</option>
          <option value="termahal">Harga Termahal</option>
        </select>
      </div>
    </div>

    <div class="product-grid" id="productGrid">
      <!-- Products akan di-render di sini -->
    </div>
  </div>

  <div id="footer-container"></div>
  
  <script src="../assets/js/alert.js"></script>
  <script src="../assets/js/config.js"></script>
  <script>
    // =========================
    // UTIL
    // =========================
    const formatRupiah = (n) => (n === null || n === undefined ? "" : "Rp " + Number(n).toLocaleString("id-ID"));
    const getQueryId = () => new URLSearchParams(window.location.search).get("id");
    const toAbsoluteUrl = (u) => (!u ? "" : u.startsWith("http") ? u : `${API_BASE}${u}`);
  
    function cariVarian(varianProduk, selectedValueIds) {
      for (const v of varianProduk || []) {
        const nilaiIdsVarian = (v.atribut || []).map((a) => a.nilaiId).filter(Boolean);
        const cocok = selectedValueIds.every((id) => nilaiIdsVarian.includes(id));
        if (cocok) return v;
      }
      return null;
    }
  
    
      function rupiah(n) {
        return "Rp " + Number(n || 0).toLocaleString("id-ID");
      }
  
      function formatDate(dateString) {
        if (!dateString) return "-";
        const d = new Date(dateString);
        if (Number.isNaN(d.getTime())) return "-";
        return d.toLocaleDateString("id-ID", {
          day: "numeric",
          month: "long",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }
  
      function escapeHtml(str) {
        return String(str || "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }
  
  
  
  
      
    // Header component - wrapped in DOMContentLoaded untuk memastikan semua element sudah ada
    window.addEventListener('headerLoaded', () => {
      initHeaderComponent();
    });
    
  
    function initHeaderComponent() {
      
      const userIcon = document.getElementById('userIcon');
      const keranjangIcon = document.getElementById('keranjangIcon');
      const userDropdown = document.getElementById('userDropdown');
      const cartDropdown = document.getElementById('cartDropdown');
      const dropdownOverlay = document.getElementById('dropdownOverlay');
      
      let activeDropdown = null;
  
      // ===== DROPDOWN TOGGLE =====
      function toggleDropdown(dropdown) {
        if (activeDropdown === dropdown) {
          closeAllDropdowns();
        } else {
          closeAllDropdowns();
          dropdown.classList.add('active');
          dropdownOverlay.classList.add('active');
          document.body.classList.add('dropdown-open');
          activeDropdown = dropdown;
        }
      }
  
      function closeAllDropdowns() {
        userDropdown?.classList.remove('active');
        cartDropdown?.classList.remove('active');
        dropdownOverlay?.classList.remove('active');
        document.body.classList.remove('dropdown-open');
        activeDropdown = null;
      }
  
      // Event listeners
      userIcon?.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        toggleDropdown(userDropdown);
      });
  
      keranjangIcon?.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        toggleDropdown(cartDropdown);
        loadCartDropdown();
      });
  
      dropdownOverlay?.addEventListener('click', closeAllDropdowns);
  
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && activeDropdown) {
          closeAllDropdowns();
        }
      });
  
      document.addEventListener('click', (e) => {
        if (window.innerWidth > 768) {
          if (!userDropdown?.contains(e.target) && 
              !userIcon?.contains(e.target) &&
              !cartDropdown?.contains(e.target) &&
              !keranjangIcon?.contains(e.target)) {
            closeAllDropdowns();
          }
        }
      });
  
      // ===== AUTH HELPERS =====
      function getToken() {
        return localStorage.getItem('token') || sessionStorage.getItem('token');
      }
  
      function parseJWT(token) {
        try {
          return JSON.parse(atob(token.split('.')[1]));
        } catch {
          return null;
        }
      }
  
      function getUserNamaSafe() {
        const ls = localStorage.getItem("userNama") || sessionStorage.getItem("userNama");
        if (ls) return ls;
  
        const token = localStorage.getItem("token") || sessionStorage.getItem("token");
        if (!token) return "User";
  
        try {
          const payload = JSON.parse(atob(token.split(".")[1]));
          return payload?.nama || payload?.email?.split("@")[0] || "Useri";
        } catch {
          return "Users";
        }
      }
      // ===== USER DROPDOWN =====
      function renderUserDropdown() {
        const token = getToken();
        const nameEl = document.getElementById('userDropdownName');
        const subEl = document.getElementById('userDropdownSub');
        const itemsEl = document.getElementById('userDropdownItems');
  
        if (token) {
          const payload = parseJWT(token);
          const userName = getUserNamaSafe();
          
          nameEl.textContent = userName;
          subEl.textContent = 'Member';
  
          itemsEl.innerHTML = `
            <a href="/profil.html" class="user-dropdown__item">
              <i class="far fa-user"></i>
              <span>Profil Saya</span>
            </a>
            <a href="/pesanan.html" class="user-dropdown__item">
              <i class="fas fa-box"></i>
              <span>Pesanan Saya</span>
            </a>
            <div class="user-dropdown__divider"></div>
            <a href="#" class="user-dropdown__item user-dropdown__danger" onclick="headerLogout(event)">
              <i class="fas fa-sign-out-alt"></i>
              <span>Keluar</span>
            </a>
          `;
        } else {
          nameEl.textContent = 'Guest';
          subEl.textContent = 'Belum login';
  
          itemsEl.innerHTML = `
            <a href="/auth/login.html" class="user-dropdown__item">
              <i class="fas fa-sign-in-alt"></i>
              <span>Masuk</span>
            </a>
            <a href="/auth/daftar.html" class="user-dropdown__item">
              <i class="fas fa-user-plus"></i>
              <span>Daftar</span>
            </a>
            <div class="user-dropdown__divider"></div>
            <a href="/footer/bantuan.html" class="user-dropdown__item">
              <i class="fas fa-question-circle"></i>
              <span>Bantuan</span>
            </a>
          `;
        }
      }
  
      // ===== CART BADGE =====
      async function loadCartBadge() {
        const token = getToken();
        const badge = document.getElementById('keranjangBadge');
        
        if (!token) {
          badge.style.display = 'none';
          return;
        }
  
        try {
          const res = await fetch(`${API_BASE}/api/keranjang`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
  
          if (res.ok) {
            const data = await res.json();
            const itemCount = data.item?.length || 0;
            
            if (itemCount > 0) {
              badge.textContent = itemCount > 99 ? '99+' : itemCount;
              badge.style.display = 'block';
            } else {
              badge.style.display = 'none';
            }
          } else {
            badge.style.display = 'none';
          }
        } catch (err) {
          console.error('Error loading cart badge:', err);
          badge.style.display = 'none';
        }
      }
  
      // ===== CART DROPDOWN =====
      async function loadCartDropdown() {
        const token = getToken();
        const itemsEl = document.getElementById('cartDropdownItems');
        const footerEl = document.getElementById('cartDropdownFooter');
        const countEl = document.getElementById('cartDropdownCount');
        const totalEl = document.getElementById('cartDropdownTotal');
  
        if (!token) {
          itemsEl.innerHTML = `
            <div class="cart-dropdown__empty">
              <i class="fas fa-shopping-bag"></i>
              <p>Silakan login untuk melihat keranjang</p>
            </div>
          `;
          footerEl.style.display = 'none';
          return;
        }
  
        try {
          const res = await fetch(`${API_BASE}/api/keranjang`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
  
          if (!res.ok) throw new Error('Failed to load cart');
  
          const data = await res.json();
          const items = data.item || [];
  
          if (items.length === 0) {
            itemsEl.innerHTML = `
              <div class="cart-dropdown__empty">
                <i class="fas fa-shopping-bag"></i>
                <p>Keranjang Anda masih kosong</p>
              </div>
            `;
            footerEl.style.display = 'none';
            countEl.textContent = '0 Item';
            return;
          }
  
          // Render items
          let totalPrice = 0;
          itemsEl.innerHTML = items.map(item => {
            const nama = item.produk?.nama || 'Produk';
            const harga = item.varian?.harga ?? item.produk?.harga ?? 0;
            const qty = item.jumlah || 1;
            const subtotal = harga * qty;
            totalPrice += subtotal;
  
            // Get variant attributes
            const attrs = [];
            if (item.varian?.atribut) {
              item.varian.atribut.forEach(a => {
                const label = a.nilai?.atribut?.nama;
                const value = a.nilai?.nilai;
                if (label && value) attrs.push(`${label}: ${value}`);
              });
            }
            const variantText = attrs.join(', ');
  
            const gambar = item.produk?.gambarUtama || '';
            const imgUrl = gambar.startsWith('http') ? gambar : `${API_BASE}${gambar}`;
  
            return `
              <div class="cart-item">
                <div class="cart-item__image">
                  ${gambar ? `<img src="${imgUrl}" alt="${nama}">` : 'ðŸ“¦'}
                </div>
                <div class="cart-item__info">
                  <div class="cart-item__name">${nama}</div>
                  ${variantText ? `<div class="cart-item__variant">${variantText}</div>` : ''}
                  <div class="cart-item__bottom">
                    <div class="cart-item__price">Rp ${Number(harga).toLocaleString('id-ID')}</div>
                    <div class="cart-item__qty">x${qty}</div>
                  </div>
                </div>
              </div>
            `;
          }).join('');
  
          countEl.textContent = `${items.length} Item${items.length > 1 ? 's' : ''}`;
          totalEl.textContent = `Rp ${Number(totalPrice).toLocaleString('id-ID')}`;
          footerEl.style.display = 'block';
  
        } catch (err) {
          console.error('Error loading cart dropdown:', err);
          itemsEl.innerHTML = `
            <div class="cart-dropdown__empty">
              <i class="fas fa-exclamation-circle"></i>
              <p>Gagal memuat keranjang</p>
            </div>
          `;
          footerEl.style.display = 'none';
        }
      }
  
      // ===== LOGOUT =====
      window.headerLogout = async function (e) {
        if (e) e.preventDefault();
  
        const ok = await showConfirm({
          title: "Keluar",
          message: "Apakah Anda yakin ingin keluar?",
          confirmText: "Keluar",
          cancelText: "Batal",
          type: "danger",
          closeOnBackdrop: true,
        });
  
        if (!ok) return;
  
        localStorage.removeItem("token");
        sessionStorage.removeItem("token");
        localStorage.removeItem("userNama");
        sessionStorage.removeItem("userNama");
  
        if (typeof showAlert === "function") showAlert("Berhasil logout", "success");
  
        // kalau kamu punya refresh header (di helpersindex.js)
        if (typeof window.refreshHeader === "function") window.refreshHeader();
  
        setTimeout(() => {
          window.location.href = "/index.html";
        }, 600);
      };
  
  
      // ===== INIT =====
      renderUserDropdown();
      loadCartBadge();
  
      if (getToken()) {
        setInterval(loadCartBadge, 30000);
      }
  
      window.addEventListener('storage', (e) => {
        if (e.key === 'token' || e.key === null) {
          renderUserDropdown();
          loadCartBadge();
        }
      });
  
      // Expose refresh function globally
      window.refreshHeader = function() {
        renderUserDropdown();
        loadCartBadge();
      };
    }
  
    // include-helper.js
  // Helper untuk load header dan footer di semua halaman
  
  (function() {
    'use strict';
  
    // Function untuk load header dan footer
    window.includeHeaderFooter = function(callback) {
      Promise.all([
        fetch('../headerindex.html').then(res => {
          if (!res.ok) throw new Error('Header not found');
          return res.text();
        }),
        fetch('../footer.html').then(res => {
          if (!res.ok) throw new Error('Footer not found');
          return res.text();
        })
      ])
      .then(([headerHtml, footerHtml]) => {
        // Inject header
        const headerContainer = document.getElementById('header-container');
        if (headerContainer) {
          headerContainer.innerHTML = headerHtml;
        }
  
        // Inject footer
        const footerContainer = document.getElementById('footer-container');
        if (footerContainer) {
          footerContainer.innerHTML = footerHtml;
        }
  
        // Dispatch event bahwa header sudah loaded
        window.dispatchEvent(new Event('headerLoaded'));
  
        // Call callback jika ada
        if (typeof callback === 'function') {
          setTimeout(callback, 150); // Tunggu sebentar untuk script header execute
        }
      })
      .catch(err => {
        console.error('Error loading header/footer:', err);
      });
    };
  
    // Auto load saat DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        window.includeHeaderFooter();
      });
    } else {
      // DOM already loaded
      window.includeHeaderFooter();
    }
  })();
  </script>
  
  <script>

    let allProducts = [];

    async function loadProducts() {
      try {
        const products = await apiRequest("/api/produk");
        allProducts = (products || []).filter(p => p.aktif === true);
        renderProducts(allProducts);
        loadCategories();
      } catch (err) {
        console.error(err);
      }
    }

    async function loadCategories() {
      try {
        const categories = await apiRequest("/api/kategori");
        const select = document.getElementById('filterKategori');
        categories.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat.id;
          option.textContent = cat.nama;
          select.appendChild(option);
        });
      } catch (err) {
        console.error(err);
      }
    }

    function renderProducts(products) {
      const grid = document.getElementById('productGrid');
      grid.innerHTML = '';

      if (!products.length) {
        grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">Tidak ada produk</p>';
        return;
      }

      products.forEach(p => {
        const imageHtml = p.gambarUtama
          ? `<img src="${imgUrl(p.gambarUtama)}" alt="${p.nama}">`
          : `ðŸ“¦`;

        const diskonBadge = p.diskonPersen
          ? `<span class="discount-badge">-${p.diskonPersen}%</span>`
          : "";

        const original = p.hargaAsli
          ? `<span class="original-price">Rp ${rupiah(p.hargaAsli)}</span>`
          : "";

        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = `
          <div class="product-image">
            ${imageHtml}
            ${diskonBadge}
          </div>
          <div class="product-info">
            <div class="product-name">${escapeHtml(p.nama)}</div>
            <div class="price-container">
              <span class="current-price">Rp ${rupiah(p.harga)}</span>
              ${original}
            </div>
            <div class="product-sold">Terjual ${formatTerjual(p.terjual)}</div>
          </div>
        `;

        card.onclick = () => window.location.href = `../produk.html?id=${p.id}`;
        grid.appendChild(card);
      });
    }

    function rupiah(n) {
      return Number(n || 0).toLocaleString("id-ID");
    }

    function escapeHtml(str) {
      return String(str || "").replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;");
    }

    function imgUrl(u) {
      if (!u) return "";
      if (u.startsWith("http")) return u;
      return `${window.API_BASE}${u}`;
    }

    // Fungsi untuk apply filter dan sort bersamaan
    function applyFilters() {
      const kategoriId = document.getElementById('filterKategori').value;
      const sort = document.getElementById('filterSort').value;

      // Filter berdasarkan kategori
      let filtered = kategoriId
        ? allProducts.filter(p => String(p.kategoriId) === String(kategoriId))
        : [...allProducts];

      // Sort
      if (sort === 'terlaris') {
        filtered.sort((a, b) => (b.terjual || 0) - (a.terjual || 0));
      } else if (sort === 'termurah') {
        filtered.sort((a, b) => a.harga - b.harga);
      } else if (sort === 'termahal') {
        filtered.sort((a, b) => b.harga - a.harga);
      }
      // 'terbaru' tidak perlu sorting khusus, gunakan urutan default dari API

      renderProducts(filtered);
    }

    // Event listeners
    document.getElementById('filterKategori')?.addEventListener('change', applyFilters);
    document.getElementById('filterSort')?.addEventListener('change', applyFilters);

    document.addEventListener('DOMContentLoaded', loadProducts);
  </script>
</body>
</html>