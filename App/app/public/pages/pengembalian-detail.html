<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Status Pengembalian - Ashanum</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="/favicon.png?v=2">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary:#EE4D2D; --primary-dark:#d43f20; --primary-light:#fff3f0; --primary-mid:#ffd8cc;
      --green:#26aa99; --green-light:#f0faf9;
      --orange:#f57224; --blue:#1890ff;
      --bg:#f5f5f5; --white:#ffffff; --border:#e8e8e8;
      --gray-50:#fafafa; --gray-100:#f5f5f5; --gray-200:#eeeeee; --gray-300:#e0e0e0;
      --gray-500:#9e9e9e; --gray-600:#757575; --gray-700:#616161; --gray-900:#212121;
      --text:#333333; --text-light:#757575;
      --radius-sm:6px; --radius:10px; --radius-lg:14px;
      --shadow-sm:0 2px 8px rgba(0,0,0,0.07);
      --shadow-primary:0 4px 16px rgba(238,77,45,0.22);
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Nunito',sans-serif;background:var(--bg);color:var(--text);font-size:14px;}

    /* TOP NAV */
    .top-nav{background:var(--white);border-bottom:2px solid var(--primary-mid);padding:0 20px;}
    .top-nav-inner{max-width:760px;margin:0 auto;height:52px;display:flex;align-items:center;gap:14px;}
    .back-link{display:flex;align-items:center;gap:7px;color:var(--text);text-decoration:none;font-size:13px;font-weight:700;padding:6px 12px;border-radius:var(--radius-sm);border:1.5px solid var(--border);background:white;transition:all 0.2s;}
    .back-link:hover{border-color:var(--primary);color:var(--primary);background:var(--primary-light);}
    .nav-divider{width:1px;height:24px;background:var(--border);}
    .nav-title{font-size:15px;font-weight:800;color:var(--gray-900);}

    .container{max-width:760px;margin:24px auto 48px;padding:0 16px;}

    /* CARD */
    .card{background:var(--white);border-radius:var(--radius-lg);border:1.5px solid var(--border);box-shadow:var(--shadow-sm);margin-bottom:16px;overflow:hidden;}
    .card-header{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;background:var(--gray-50);}
    .card-header-icon{width:32px;height:32px;border-radius:50%;background:var(--primary-light);display:flex;align-items:center;justify-content:center;color:var(--primary);font-size:14px;}
    .card-header h2{font-size:15px;font-weight:800;color:var(--gray-900);}
    .card-body{padding:20px;}

    /* STATUS BANNER */
    .status-banner{padding:20px;display:flex;align-items:center;gap:16px;}
    .status-banner-icon{width:64px;height:64px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;flex-shrink:0;}
    .status-banner-text h2{font-size:18px;font-weight:900;margin-bottom:4px;}
    .status-banner-text p{font-size:13px;line-height:1.6;}

    /* Status colors */
    .banner-diajukan      {background:var(--blue-light,#e6f4ff);border-bottom:1px solid #bae0ff;}
    .banner-diajukan      .status-banner-icon{background:#bae0ff;color:#0958d9;}
    .banner-diajukan      .status-banner-text h2{color:#0958d9;}
    .banner-disetujui     {background:var(--green-light);border-bottom:1px solid #b7e0da;}
    .banner-disetujui     .status-banner-icon{background:#b7e0da;color:var(--green);}
    .banner-disetujui     .status-banner-text h2{color:var(--green);}
    .banner-dikirim-balik {background:#fff7e6;border-bottom:1px solid #ffe7ba;}
    .banner-dikirim-balik .status-banner-icon{background:#ffe7ba;color:#d46b08;}
    .banner-dikirim-balik .status-banner-text h2{color:#d46b08;}
    .banner-selesai       {background:#f6ffed;border-bottom:1px solid #b7eb8f;}
    .banner-selesai       .status-banner-icon{background:#b7eb8f;color:#389e0d;}
    .banner-selesai       .status-banner-text h2{color:#389e0d;}
    .banner-ditolak       {background:#fff2f0;border-bottom:1px solid #ffa39e;}
    .banner-ditolak       .status-banner-icon{background:#ffa39e;color:#cf1322;}
    .banner-ditolak       .status-banner-text h2{color:#cf1322;}

    /* TIMELINE */
    .timeline{padding:4px 0;}
    .tl-item{display:flex;gap:14px;padding-bottom:0;position:relative;}
    .tl-item:not(:last-child)::before{content:'';position:absolute;left:15px;top:32px;bottom:0;width:2px;background:var(--gray-200);z-index:0;}
    .tl-item.done::before{background:var(--green);}
    .tl-dot{width:32px;height:32px;border-radius:50%;border:2.5px solid var(--gray-300);background:white;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;z-index:1;position:relative;margin-top:2px;}
    .tl-item.done .tl-dot{border-color:var(--green);background:var(--green-light);}
    .tl-item.active .tl-dot{border-color:var(--primary);background:var(--primary-light);}
    .tl-content{flex:1;padding-bottom:20px;}
    .tl-title{font-size:14px;font-weight:800;color:var(--gray-900);margin-bottom:2px;}
    .tl-item.inactive .tl-title{color:var(--gray-500);}
    .tl-desc{font-size:12px;color:var(--text-light);line-height:1.6;}
    .tl-time{font-size:11px;color:var(--gray-500);margin-top:3px;}

    /* DETAIL ROWS */
    .detail-row{display:flex;justify-content:space-between;align-items:flex-start;padding:8px 0;border-bottom:1px solid var(--gray-100);font-size:13px;}
    .detail-row:last-child{border-bottom:none;}
    .detail-key{color:var(--text-light);font-weight:600;}
    .detail-val{font-weight:700;color:var(--gray-900);text-align:right;}

    /* FOTO BUKTI */
    .foto-grid{display:flex;flex-wrap:wrap;gap:8px;}
    .foto-grid a{display:block;width:72px;height:72px;border-radius:var(--radius-sm);overflow:hidden;border:1.5px solid var(--border);}
    .foto-grid a img{width:100%;height:100%;object-fit:cover;display:block;}

    /* CATATAN ADMIN */
    .catatan-box{background:var(--gray-50);border:1.5px solid var(--border);border-radius:var(--radius-sm);padding:12px 14px;font-size:13px;color:var(--gray-700);line-height:1.6;}
    .catatan-box strong{display:block;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-light);margin-bottom:5px;}

    /* RESI INPUT */
    .resi-section{background:var(--primary-light);border:1.5px solid var(--primary-mid);border-radius:var(--radius);padding:16px;margin-bottom:16px;}
    .resi-section h4{font-size:14px;font-weight:800;color:var(--gray-900);margin-bottom:4px;}
    .resi-section p{font-size:12px;color:var(--text-light);margin-bottom:12px;line-height:1.6;}
    .resi-input-wrap{display:flex;gap:8px;}
    .resi-input{flex:1;padding:10px 13px;border:1.5px solid var(--primary-mid);border-radius:var(--radius-sm);font-family:'Nunito',sans-serif;font-size:13px;font-weight:700;outline:none;transition:border-color 0.2s;}
    .resi-input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(238,77,45,0.1);}
    .btn-resi{padding:10px 16px;background:var(--primary);color:white;border:none;border-radius:var(--radius-sm);font-family:'Nunito',sans-serif;font-size:13px;font-weight:800;cursor:pointer;white-space:nowrap;display:flex;align-items:center;gap:6px;transition:all 0.2s;box-shadow:var(--shadow-primary);}
    .btn-resi:hover{background:var(--primary-dark);}
    .btn-resi:disabled{opacity:0.6;cursor:not-allowed;}

    /* JENIS BADGE */
    .jenis-badge{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:800;}
    .jb-refund{background:#fff7e6;color:#d46b08;border:1px solid #ffe7ba;}
    .jb-tukar {background:#f9f0ff;color:#531dab;border:1px solid #d3adf7;}

    /* BUTTONS */
    .btn-primary{display:inline-flex;align-items:center;gap:8px;padding:12px 22px;background:var(--primary);color:white;border:none;border-radius:var(--radius-sm);font-family:'Nunito',sans-serif;font-size:14px;font-weight:800;cursor:pointer;box-shadow:var(--shadow-primary);transition:all 0.2s;text-decoration:none;}
    .btn-primary:hover{background:var(--primary-dark);transform:translateY(-1px);}
    .btn-outline{display:inline-flex;align-items:center;gap:8px;padding:11px 20px;background:white;color:var(--primary);border:1.5px solid var(--primary);border-radius:var(--radius-sm);font-family:'Nunito',sans-serif;font-size:14px;font-weight:800;cursor:pointer;transition:all 0.2s;text-decoration:none;}
    .btn-outline:hover{background:var(--primary-light);}

    /* LOADING */
    .page-loading{text-align:center;padding:80px 20px;}
    .spinner{width:44px;height:44px;border:4px solid var(--gray-200);border-top-color:var(--primary);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 16px;}
    @keyframes spin{to{transform:rotate(360deg);}}

    @media(max-width:600px){.container{padding:0 12px;margin-top:16px;}.resi-input-wrap{flex-direction:column;}.btn-resi{justify-content:center;}}
  </style>
</head>
<body>

  <div id="header-container"></div>

  <div class="top-nav">
    <div class="top-nav-inner">
      <a id="backLink" href="/pesanan.html" class="back-link"><i class="fas fa-arrow-left"></i> Kembali</a>
      <div class="nav-divider"></div>
      <span class="nav-title">Status Pengembalian</span>
    </div>
  </div>

  <div class="container">

    <!-- Loading -->
    <div class="page-loading" id="pageLoading">
      <div class="spinner"></div>
      <p style="color:var(--text-light);font-weight:600;">Memuat status pengembalian...</p>
    </div>

    <!-- Content -->
    <div id="pageContent" style="display:none;">

      <!-- Status Banner -->
      <div class="card" id="statusBannerCard">
        <div class="status-banner" id="statusBanner"><!-- JS --></div>
      </div>

      <!-- Resi Input (muncul saat DISETUJUI) -->
      <div id="resiSection" style="display:none;">
        <div class="resi-section">
          <h4><i class="fas fa-truck"></i> Kirim Barang Kembali</h4>
          <p>Pengembalian Anda telah disetujui! Kirim barang ke alamat yang tertera di catatan admin, lalu masukkan nomor resi pengiriman di bawah ini.</p>
          <div class="resi-input-wrap">
            <input class="resi-input" type="text" id="resiInput" placeholder="Masukkan nomor resi pengiriman barang kembali...">
            <button class="btn-resi" id="btnResi" onclick="submitResi()">
              <i class="fas fa-paper-plane"></i> Kirim Resi
            </button>
          </div>
        </div>
      </div>

      <!-- Timeline -->
      <div class="card">
        <div class="card-header">
          <div class="card-header-icon"><i class="fas fa-stream"></i></div>
          <h2>Progress Pengembalian</h2>
        </div>
        <div class="card-body">
          <div class="timeline" id="timeline"><!-- JS --></div>
        </div>
      </div>

      <!-- Catatan Admin -->
      <div class="card" id="catatanCard" style="display:none;">
        <div class="card-header">
          <div class="card-header-icon"><i class="fas fa-comment-alt"></i></div>
          <h2>Catatan dari Admin</h2>
        </div>
        <div class="card-body">
          <div class="catatan-box">
            <strong>Pesan Admin</strong>
            <span id="catatanText">-</span>
          </div>
        </div>
      </div>

      <!-- Detail Pengembalian -->
      <div class="card">
        <div class="card-header">
          <div class="card-header-icon"><i class="fas fa-info-circle"></i></div>
          <h2>Detail Pengajuan</h2>
        </div>
        <div class="card-body">
          <div id="detailRows"><!-- JS --></div>
        </div>
      </div>

      <!-- Foto Bukti -->
      <div class="card" id="fotoCard" style="display:none;">
        <div class="card-header">
          <div class="card-header-icon"><i class="fas fa-camera"></i></div>
          <h2>Foto Bukti</h2>
        </div>
        <div class="card-body">
          <div class="foto-grid" id="fotoGrid"><!-- JS --></div>
        </div>
      </div>

      <!-- Tombol aksi bawah -->
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <a id="btnLihatPesanan" href="#" class="btn-primary">
          <i class="fas fa-receipt"></i> Lihat Detail Pesanan
        </a>
        <a href="/pesanan.html" class="btn-outline">
          <i class="fas fa-shopping-bag"></i> Pesanan Saya
        </a>
      </div>

    </div>

  </div>

  <div id="footer-container"></div>

  <script src="assets/js/alert.js"></script>
  <script src="assets/js/config.js"></script>
  <script src="assets/js/helpers.js"></script>

  <script>
    let currentData = null;
    let pengembalianId = null;

    // ‚îÄ‚îÄ Config ‚îÄ‚îÄ
    const BANNER_CFG = {
      DIAJUKAN: {
        cls: "banner-diajukan", icon: "üìã",
        title: "Pengajuan Sedang Ditinjau",
        desc: "Tim kami sedang meninjau pengajuan pengembalian Anda. Proses ini biasanya memakan waktu 1√ó24 jam.",
      },
      DISETUJUI: {
        cls: "banner-disetujui", icon: "‚úÖ",
        title: "Pengembalian Disetujui!",
        desc: "Pengajuan Anda telah disetujui. Silakan kirim barang kembali ke alamat kami dan masukkan nomor resi di bawah.",
      },
      DITOLAK: {
        cls: "banner-ditolak", icon: "‚ùå",
        title: "Pengembalian Ditolak",
        desc: "Maaf, pengajuan pengembalian Anda tidak dapat diproses. Lihat catatan admin untuk informasi lebih lanjut.",
      },
      BARANG_DIKIRIM_BALIK: {
        cls: "banner-dikirim-balik", icon: "üì¶",
        title: "Barang Sedang Dikirim Kembali",
        desc: "Kami telah menerima nomor resi Anda dan sedang menunggu barang tiba di gudang kami.",
      },
      SELESAI: {
        cls: "banner-selesai", icon: "üéâ",
        title: "Pengembalian Selesai!",
        desc: "Proses pengembalian Anda telah selesai. Terima kasih atas kepercayaan Anda berbelanja di Ashanum.",
      },
    };

    const STEP_ORDER = [
      "DIAJUKAN",
      "DISETUJUI",
      "BARANG_DIKIRIM_BALIK",
      "SELESAI",
    ];

    const STEP_CFG = {
      DIAJUKAN: {
        icon: "üìã",
        title: "Pengajuan Diterima",
        desc: "Pengembalian Anda telah diajukan dan sedang menunggu tinjauan admin.",
      },
      DISETUJUI: {
        icon: "‚úÖ",
        title: "Disetujui Admin",
        desc: "Admin telah menyetujui pengajuan. Silakan kirim barang kembali.",
      },
      BARANG_DIKIRIM_BALIK: {
        icon: "üöö",
        title: "Barang Dikirim Kembali",
        desc: "Anda telah mengirim barang. Menunggu konfirmasi penerimaan dari kami.",
      },
      SELESAI: {
        icon: "üéâ",
        title: "Pengembalian Selesai",
        desc: "Refund sudah ditransfer / barang pengganti sudah dikirim.",
      },
    };

    // ‚îÄ‚îÄ Load ‚îÄ‚îÄ
    async function loadData() {
      pengembalianId = new URLSearchParams(window.location.search).get("id");
      if (!pengembalianId) {
        showAlert("ID pengembalian tidak ditemukan","error");
        return;
      }

      try {
        currentData = await apiAuth(`/api/pengembalian/${encodeURIComponent(pengembalianId)}`, { method:"GET" });

        document.getElementById("backLink").href    = `/pesanan-detail.html?orderId=${encodeURIComponent(currentData.pesananId)}`;
        document.getElementById("btnLihatPesanan").href = `/pesanan-detail.html?orderId=${encodeURIComponent(currentData.pesananId)}`;

        renderBanner();
        renderTimeline();
        renderDetail();
        renderFoto();
        renderCatatan();
        renderResiSection();

        document.getElementById("pageLoading").style.display = "none";
        document.getElementById("pageContent").style.display  = "block";

      } catch(e) {
        if (String(e.message)==="NO_LOGIN") return;
        showAlert(e.message||"Gagal memuat data","error");
      }
    }

    function renderBanner() {
      const d = currentData;
      const cfg = BANNER_CFG[d.status] || BANNER_CFG.DIAJUKAN;
      const card = document.getElementById("statusBannerCard");
      card.querySelector(".status-banner").className = `status-banner ${cfg.cls}`;
      card.style.borderColor = "";

      document.getElementById("statusBanner").innerHTML = `
        <div class="status-banner-icon">${cfg.icon}</div>
        <div class="status-banner-text">
          <h2>${cfg.title}</h2>
          <p>${cfg.desc}</p>
          <div style="margin-top:8px;">
            ${d.jenis==="REFUND"
              ? `<span class="jenis-badge jb-refund">üí∞ Refund (Uang Kembali)</span>`
              : `<span class="jenis-badge jb-tukar">üîÑ Tukar Barang</span>`}
          </div>
        </div>`;
    }

    function renderTimeline() {
      const d = currentData;
      if (d.status === "DITOLAK") {
        document.getElementById("timeline").innerHTML = `
          <div class="tl-item done">
            <div class="tl-dot">üìã</div>
            <div class="tl-content">
              <div class="tl-title">Pengajuan Diterima</div>
              <div class="tl-desc">Pengembalian berhasil diajukan</div>
              <div class="tl-time">${formatDate(d.dibuatPada)}</div>
            </div>
          </div>
          <div class="tl-item active">
            <div class="tl-dot">‚ùå</div>
            <div class="tl-content">
              <div class="tl-title" style="color:#cf1322;">Pengajuan Ditolak</div>
              <div class="tl-desc">Pengembalian tidak dapat diproses. Lihat catatan admin.</div>
              <div class="tl-time">${formatDate(d.diubahPada)}</div>
            </div>
          </div>`;
        return;
      }

      const currentIdx = STEP_ORDER.indexOf(d.status);
      const items = STEP_ORDER.map((step, i) => {
        const cfg     = STEP_CFG[step];
        const isDone   = i < currentIdx;
        const isActive = i === currentIdx;
        const cls      = isDone ? "done" : isActive ? "active" : "inactive";
        const dotIcon  = isDone ? "‚úì" : cfg.icon;
        return `
          <div class="tl-item ${cls}">
            <div class="tl-dot">${dotIcon}</div>
            <div class="tl-content">
              <div class="tl-title">${cfg.title}</div>
              <div class="tl-desc">${cfg.desc}</div>
              ${isDone||isActive ? `<div class="tl-time">${i===0?formatDate(d.dibuatPada):formatDate(d.diubahPada)}</div>` : ""}
            </div>
          </div>`;
      });

      document.getElementById("timeline").innerHTML = items.join("");
    }

    function renderDetail() {
      const d = currentData;
      const rows = [
        { key: "ID Pengembalian",  val: `#${d.id}` },
        { key: "ID Pesanan",       val: `#${d.pesananId}` },
        { key: "Jenis",            val: d.jenis === "REFUND" ? "üí∞ Refund (Uang Kembali)" : "üîÑ Tukar Barang" },
        { key: "Alasan",           val: escapeHtml(d.alasan||"-") },
        d.deskripsi ? { key:"Deskripsi", val: escapeHtml(d.deskripsi) } : null,
        { key: "Tanggal Diajukan", val: formatDate(d.dibuatPada) },
        d.resiKembali ? { key:"Resi Kembali", val: `<span style="font-family:monospace;color:var(--primary);font-weight:800;">${escapeHtml(d.resiKembali)}</span>` } : null,
      ].filter(Boolean);

      document.getElementById("detailRows").innerHTML = rows.map(r =>
        `<div class="detail-row">
          <span class="detail-key">${r.key}</span>
          <span class="detail-val">${r.val}</span>
        </div>`
      ).join("");
    }

    function renderFoto() {
      const fotos = currentData.foto || [];
      if (!fotos.length) return;
      document.getElementById("fotoCard").style.display = "";
      document.getElementById("fotoGrid").innerHTML = fotos.map(f =>
        `<a href="${toAbsoluteUrl(f)}" target="_blank">
          <img src="${toAbsoluteUrl(f)}" alt="Foto bukti">
        </a>`
      ).join("");
    }

    function renderCatatan() {
      if (!currentData.catatanAdmin) return;
      document.getElementById("catatanCard").style.display = "";
      document.getElementById("catatanText").textContent = currentData.catatanAdmin;
    }

    function renderResiSection() {
      if (currentData.status !== "DISETUJUI") return;
      document.getElementById("resiSection").style.display = "";
    }

    // ‚îÄ‚îÄ Submit Resi ‚îÄ‚îÄ
    async function submitResi() {
      const resi = document.getElementById("resiInput").value.trim();
      if (!resi) return showAlert("Nomor resi wajib diisi","warning");

      const btn = document.getElementById("btnResi");
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengirim...';

      try {
        await apiAuth(`/api/pengembalian/${encodeURIComponent(pengembalianId)}/resi-kembali`, {
          method: "PATCH",
          body: JSON.stringify({ resiKembali: resi }),
        });

        showAlert("‚úÖ Nomor resi berhasil disimpan!","success");
        // Reload untuk refresh timeline
        loadData();
      } catch(e) {
        showAlert(e.message||"Gagal menyimpan resi","error");
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-paper-plane"></i> Kirim Resi';
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      if (typeof showAlert !== "function") window.showAlert = msg => alert(msg);
      loadData();
    });
  </script>
</body>
</html>